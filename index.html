<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
  <title>Matrice Contr√¥le Qualit√© - v2.1</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <script>
    // ================================================================================================
    // üîß CONFIGURATION DES COLONNES - MODIFIEZ ICI SELON VOTRE FICHIER DE BOOKING
    // ================================================================================================
    
    // üìã Configuration pour le fichier de BOOKING (fichier Excel .xlsx)
    // ‚ö†Ô∏è  IMPORTANT: Les index de colonnes commencent √† 0 (A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, etc.)
    
    const BOOKING_COL_CODE_ARTICLE = 7;    // üìç Colonne H (index 7) = Code Article
    const BOOKING_COL_BOOKING_NUMBER = 13; // üìç Colonne N (index 13) = Num√©ro de Booking
    
    // üí° Pour modifier ces colonnes selon votre fichier :
    // - Si votre code article est en colonne C, mettez : BOOKING_COL_CODE_ARTICLE = 2
    // - Si votre num√©ro booking est en colonne F, mettez : BOOKING_COL_BOOKING_NUMBER = 5
    // - R√©f√©rence : A=0, B=1, C=2, D=3, E=4, F=5, G=6, H=7, I=8, J=9, K=10, L=11, M=12, N=13, etc.
    
    // üìä Configuration pour le fichier de BDD (fichier CSV .csv)
    // ‚ö†Ô∏è  Ces colonnes sont g√©n√©ralement fixes mais vous pouvez les ajuster si n√©cessaire
    
    const COL_REF = 0;      // üìç Colonne A = R√©f√©rence produit
    const COL_CODE = 1;     // üìç Colonne B = Code article  
    const COL_COULEUR = 2;  // üìç Colonne C = Couleur
    const COL_TAILLE = 4;   // üìç Colonne E = Taille
    const COL_MARQUE = 7;   // üìç Colonne H = Marque
    const COL_EAN = 10;     // üìç Colonne K = Code EAN
    
    // ================================================================================================
    // üîö FIN DE LA CONFIGURATION - Ne modifiez pas le code en dessous sauf si n√©cessaire
    // ================================================================================================

    // Classe pour g√©rer les notifications
    window.NotificationManager = class {
      static show(message, type = 'info', duration = 3000) {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
          <div class="notification-content">
            <span class="notification-icon">${this.getIcon(type)}</span>
            <span class="notification-message">${message}</span>
            <button class="notification-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
          </div>
        `;
        
        document.body.appendChild(notification);
        
        // Animation d'entr√©e
        setTimeout(() => notification.classList.add('show'), 100);
        
        // Suppression automatique
        setTimeout(() => {
          notification.classList.remove('show');
          setTimeout(() => notification.remove(), 300);
        }, duration);
      }
      
      static getIcon(type) {
        const icons = {
          success: '‚úÖ',
          error: '‚ùå',
          warning: '‚ö†Ô∏è',
          info: '‚ÑπÔ∏è'
        };
        return icons[type] || '‚ÑπÔ∏è';
      }
    };

    // Gestionnaire de stockage local am√©lior√©
    window.StorageManager = class {
      static save(key, data) {
        try {
          const serialized = JSON.stringify(data);
          localStorage.setItem(`qc_${key}`, serialized);
          return true;
        } catch (error) {
          console.error('Erreur sauvegarde:', error);
          return false;
        }
      }
      
      static load(key) {
        try {
          const serialized = localStorage.getItem(`qc_${key}`);
          return serialized ? JSON.parse(serialized) : null;
        } catch (error) {
          console.error('Erreur chargement:', error);
          return null;
        }
      }
      
      static remove(key) {
        try {
          localStorage.removeItem(`qc_${key}`);
          return true;
        } catch (error) {
          console.error('Erreur suppression:', error);
          return false;
        }
      }
      
      static clear() {
        try {
          Object.keys(localStorage).forEach(key => {
            if (key.startsWith('qc_')) {
              localStorage.removeItem(key);
            }
          });
          return true;
        } catch (error) {
          console.error('Erreur nettoyage:', error);
          return false;
        }
      }
    };

    // Variables globales pour les scanners
    let codeReader = null;
    let eanCodeReader = null;
    window.isScanning = false;
    window.isEanScanning = false;
  </script>
  
  <script type="module">
    import { BrowserMultiFormatReader } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    // Exposer BrowserMultiFormatReader globalement
    window.BrowserMultiFormatReader = BrowserMultiFormatReader;

    // Scanner am√©lior√© avec gestion d'erreurs
    window.startCamera = async function() {
      const video = document.getElementById('video');
      const scanButton = document.getElementById('scanButton');
      const stopButton = document.getElementById('stopButton');
      
      try {
        if (window.codeReader) {
          window.codeReader.reset();
        }
        
        window.codeReader = new window.BrowserMultiFormatReader();
        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        
        await window.codeReader.decodeFromConstraints(constraints, video, (result, err) => {
          if (result && window.isScanning) {
            document.getElementById("barcodeInput").value = result.text;
            window.stopCamera();
            findProduct();
            if (navigator.vibrate) {
              navigator.vibrate(200);
            }
            window.NotificationManager.show('Code scann√© avec succ√®s!', 'success');
          }
        });
        
        window.isScanning = true;
        video.style.display = 'block';
        scanButton.style.display = 'none';
        stopButton.style.display = 'inline-block';
        document.getElementById('scannerContainer').style.display = 'block';
        
      } catch (err) {
        console.error('Erreur cam√©ra:', err);
        window.NotificationManager.show('Impossible d\'acc√©der √† la cam√©ra. V√©rifiez les permissions.', 'error');
        resetCameraButtons();
      }
    };

    window.stopCamera = function() {
      window.isScanning = false;
      
      const video = document.getElementById('video');
      if (video && video.srcObject) {
        const stream = video.srcObject;
        if (stream) {
          stream.getTracks().forEach(track => {
            track.stop();
          });
          video.srcObject = null;
        }
      }
      
      if (window.codeReader) {
        try {
          window.codeReader.reset();
        } catch (e) {
          console.log('Erreur lors de l\'arr√™t de la cam√©ra:', e);
        }
        window.codeReader = null;
      }
      
      resetCameraButtons();
    };

    function resetCameraButtons() {
      const video = document.getElementById('video');
      if (video) {
        video.style.display = 'none';
        if (video.srcObject) {
          video.srcObject = null;
        }
      }
      
      document.getElementById('scanButton').style.display = 'inline-block';
      document.getElementById('stopButton').style.display = 'none';
      document.getElementById('scannerContainer').style.display = 'none';
    }
  </script>
  
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      margin: 0;
      padding: 10px;
      color: #2c3e50;
      min-height: 100vh;
    }
    
    .container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      max-width: 100%;
      margin: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    h1 {
      text-align: center;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 1.5em;
    }
    
    /* Notifications am√©lior√©es */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      transform: translateX(400px);
      transition: transform 0.3s ease;
      z-index: 1000;
      max-width: 350px;
      border-left: 4px solid;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .notification-success {
      border-left-color: #28a745;
    }
    
    .notification-error {
      border-left-color: #dc3545;
    }
    
    .notification-warning {
      border-left-color: #ffc107;
    }
    
    .notification-info {
      border-left-color: #17a2b8;
    }
    
    .notification-content {
      display: flex;
      align-items: center;
      padding: 15px;
      gap: 10px;
    }
    
    .notification-icon {
      font-size: 1.2em;
    }
    
    .notification-message {
      flex: 1;
      font-size: 0.9em;
    }
    
    .notification-close {
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      color: #6c757d;
      padding: 0;
      margin-left: 10px;
    }
    
    .notification-close:hover {
      color: #000;
    }
    
    .section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }
    
    .section h3 {
      margin: 0 0 15px 0;
      color: #495057;
      font-size: 1.1em;
    }
    
    .section.active {
      border-color: #667eea;
      background: #f0f3ff;
      transform: scale(1.02);
    }
    
    .section.completed {
      border-color: #28a745;
      background: #f0fff4;
    }
    
    input[type="file"], input[type="text"], select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
      transition: border-color 0.3s ease;
    }
    
    input[type="file"]:focus, 
    input[type="text"]:focus, 
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.3);
    }
    
    button {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border: none;
      color: white;
      padding: 12px 20px;
      margin: 5px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      min-height: 44px;
      transition: all 0.3s ease;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .button-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .button-row button {
      flex: 1;
      min-width: 120px;
    }
    
    /* Styles pour la section d'aide */
    .help-section {
      background: linear-gradient(135deg, #e8f5e8, #f0f8ff);
      border: 1px solid #4caf50;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .help-section h4 {
      margin: 0 0 15px 0;
      color: #2e7d32;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .help-content {
      display: grid;
      gap: 12px;
    }
    
    .help-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
      border-left: 3px solid #4caf50;
    }
    
    .help-icon {
      font-size: 1.2em;
      min-width: 24px;
      text-align: center;
    }
    
    .help-text {
      flex: 1;
      font-size: 0.9em;
      line-height: 1.4;
    }
    
    .help-text strong {
      color: #2e7d32;
      font-weight: 600;
    }
    
    /* Styles pour la section de r√©initialisation du cache */
    .cache-reset-section {
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #4caf50;
      text-align: center;
    }
    
    .cache-reset-btn {
      background: linear-gradient(135deg, #ff6b6b, #ee5a52) !important;
      font-size: 0.85em !important;
      padding: 8px 15px !important;
      min-height: auto !important;
      margin: 0 0 8px 0 !important;
      transition: all 0.3s ease;
    }
    
    .cache-reset-btn:hover {
      background: linear-gradient(135deg, #ff5252, #e53935) !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.4);
    }
    
    .cache-reset-section small {
      color: #666;
      font-size: 0.8em;
      display: block;
    }
    
    /* Styles pour la nouvelle interface de chargement */
    .files-status {
      margin: 20px 0;
      display: grid;
      gap: 15px;
    }
    
    .file-status-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 10px;
      padding: 15px;
      transition: all 0.3s ease;
    }
    
    .file-status-item.loaded {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      border-color: #28a745;
    }
    
    .file-status-item.error {
      background: linear-gradient(135deg, #f8d7da, #f5c6cb);
      border-color: #dc3545;
    }
    
    .file-status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .file-status-header h4 {
      margin: 0;
      color: #495057;
      font-size: 1.1em;
    }
    
    .file-actions {
      display: flex;
      gap: 8px;
    }
    
    .reload-btn {
      background: #6c757d !important;
      padding: 6px 12px !important;
      font-size: 0.8em !important;
      min-height: auto !important;
      margin: 0 !important;
    }
    
    .reload-btn:hover {
      background: #545b62 !important;
      transform: translateY(-1px);
    }
    
    .reload-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .status-display {
      font-size: 0.9em;
      padding: 8px 12px;
      border-radius: 5px;
      background: #e9ecef;
      color: #495057;
      min-height: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-display.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .status-display.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    
    .status-display.loading {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .global-status {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border-radius: 10px;
      border: 1px solid #2196f3;
      text-align: center;
    }
    
    .global-status.ready {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      border-color: #28a745;
    }
    
    .global-status-display {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 15px;
      font-weight: bold;
      font-size: 1.1em;
    }
    
    .continue-button {
      background: linear-gradient(135deg, #28a745, #20c997) !important;
      font-size: 1.1em !important;
      padding: 15px 30px !important;
      min-height: auto !important;
    }
    
    .continue-button:disabled {
      background: #6c757d !important;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    .manual-download {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .manual-download h5 {
      margin: 0 0 10px 0;
      color: #856404;
    }
    
    .download-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin: 10px 0;
    }
    
    .download-link {
      background: #007bff;
      color: white;
      padding: 8px 15px;
      text-decoration: none;
      border-radius: 5px;
      font-size: 0.9em;
      display: inline-block;
    }
    
    .download-link:hover {
      background: #0056b3;
      color: white;
      text-decoration: none;
    }
    
    /* Am√©liorations visuelles pour les sections importantes */
    .progress-section {
      background: linear-gradient(135deg, #667eea, #764ba2);
      border-radius: 15px;
      padding: 20px;
      margin: 15px 0;
      color: white;
      text-align: center;
    }
    
    .progress-section h4 {
      margin: 0 0 15px 0;
      font-size: 1.2em;
    }
    
    .progress-bar-container {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 15px;
      height: 25px;
      overflow: hidden;
      margin: 15px 0;
      position: relative;
    }
    
    .progress-bar-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      width: 0%;
      transition: width 0.5s ease;
      border-radius: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      font-size: 0.9em;
      position: relative;
    }
    
    .progress-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(
        90deg, 
        transparent, 
        rgba(255,255,255,0.3), 
        transparent
      );
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }
    
    /* Scanner am√©lior√© */
    #scannerContainer {
      display: none;
      text-align: center;
      margin: 15px 0;
      position: relative;
    }
    
    #video, #eanVideo {
      width: 100%;
      max-width: 400px;
      height: 300px;
      border: 3px solid #667eea;
      border-radius: 15px;
      object-fit: cover;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .scanner-overlay {
      position: relative;
      display: inline-block;
    }
    
    .scanner-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 250px;
      height: 150px;
      border: 3px solid #00ff00;
      border-radius: 15px;
      pointer-events: none;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.4); }
      70% { box-shadow: 0 0 0 20px rgba(0, 255, 0, 0); }
      100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); }
    }
    
    .scanner-corners {
      position: absolute;
      width: 25px;
      height: 25px;
      border: 4px solid #00ff00;
    }
    
    .corner-tl { top: -4px; left: -4px; border-right: none; border-bottom: none; }
    .corner-tr { top: -4px; right: -4px; border-left: none; border-bottom: none; }
    .corner-bl { bottom: -4px; left: -4px; border-right: none; border-top: none; }
    .corner-br { bottom: -4px; right: -4px; border-left: none; border-top: none; }
    
    /* Indicateurs de statut am√©lior√©s */
    .status-indicator {
      display: inline-block;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse-status 2s infinite;
    }
    
    .status-indicator.pending {
      background: #ffc107;
    }
    
    .status-indicator.success {
      background: #28a745;
    }
    
    .status-indicator.error {
      background: #dc3545;
    }
    
    @keyframes pulse-status {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Loading spinner */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Styles pour les listes de booking et produits */
    .booking-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 10px 0;
    }
    
    .booking-item, .product-item {
      padding: 12px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .booking-item:hover, .product-item:hover {
      background-color: #e9ecef;
      transform: translateX(5px);
    }
    
    .booking-item:last-child, .product-item:last-child {
      border-bottom: none;
    }
    
    .booking-ref, .product-ref {
      font-weight: bold;
      color: #667eea;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .booking-details, .product-details {
      font-size: 0.9em;
      color: #666;
      margin-top: 5px;
    }
    
    .no-results {
      text-align: center;
      padding: 20px;
      color: #6c757d;
      font-style: italic;
    }
    
    /* Styles pour les informations de booking */
    .current-booking-info {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
    }
    
    .current-booking-info h4 {
      margin: 0 0 10px 0;
      font-size: 1.2em;
    }
    
    /* Styles pour la liste des r√©f√©rences */
    .reference-list {
      background: white;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
    }
    
    .reference-list h4 {
      margin: 0 0 15px 0;
      color: #495057;
    }
    
    .reference-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      margin: 15px 0;
      background: #f8f9fa;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    
    .reference-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
      transition: left 0.5s ease;
    }
    
    .reference-item:hover::before {
      left: 100%;
    }
    
    .reference-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    
    .reference-item.completed {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      border-color: #28a745;
    }
    
    .reference-item.current {
      background: linear-gradient(135deg, #fff3cd, #ffeaa7);
      border-color: #ffc107;
      box-shadow: 0 5px 20px rgba(255, 193, 7, 0.4);
    }
    
    .reference-info {
      flex: 1;
    }
    
    .reference-code {
      font-weight: bold;
      color: #495057;
      font-size: 1.1em;
    }
    
    .reference-details {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 5px;
    }
    
    .reference-status {
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .reference-status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .reference-status.completed {
      background: #d4edda;
      color: #155724;
    }
    
    .reference-status.current {
      background: #cce5ff;
      color: #004085;
    }
    
    /* Styles pour les boutons de navigation */
    .navigation-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }
    
    .navigation-buttons button {
      min-width: 150px;
    }
    
    .hidden {
      display: none;
    }
    
    /* Styles pour les crit√®res de qualit√© */
    .quality-criterion {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
    }
    
    .criterion-title {
      font-weight: bold;
      color: #495057;
      margin-bottom: 10px;
      font-size: 1.1em;
    }
    
    .radio-group {
      display: flex;
      gap: 20px;
      margin: 10px 0;
      align-items: center;
    }
    
    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    
    .radio-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin: 0;
    }
    
    .radio-option.ok {
      color: #28a745;
      font-weight: bold;
    }
    
    .radio-option.not-ok {
      color: #dc3545;
      font-weight: bold;
    }
    
    .comment-area {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
      resize: vertical;
      min-height: 60px;
      margin-top: 10px;
    }
    
    .product-info {
      background: #e8f4f8;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .product-info h4 {
      margin: 0 0 10px 0;
      color: #0c5460;
    }
    
    /* Styles pour les photos */
    .photo-section {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #e9ecef;
    }

    .photo-upload {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .photo-upload input[type="file"] {
      flex: 1;
      padding: 8px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 0.85rem;
    }

    .photo-button {
      background: #17a2b8;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }

    .photo-button:hover {
      background: #138496;
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(23, 162, 184, 0.3);
    }

    .photo-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .photo-item {
      position: relative;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      background: #f8f9fa;
      transition: all 0.3s ease;
    }

    .photo-item:hover {
      border-color: #28a745;
      transform: scale(1.02);
    }

    .photo-item img {
      width: 100%;
      height: 100px;
      object-fit: cover;
      display: block;
    }

    .photo-remove {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(220, 53, 69, 0.9);
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .photo-remove:hover {
      background: #dc3545;
      transform: scale(1.1);
    }

    .photo-timestamp {
      padding: 5px;
      font-size: 0.7rem;
      color: #6c757d;
      text-align: center;
      background: rgba(248, 249, 250, 0.9);
    }
    
    /* Styles pour le contr√¥le EAN */
    .ean-progress {
      background: #e8f4f8;
      border: 1px solid #bee5eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      text-align: center;
    }

    .ean-progress h4 {
      margin: 0 0 10px 0;
      color: #0c5460;
    }

    .progress-bar {
      background: #e9ecef;
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
      margin: 10px 0;
    }

    .progress-fill {
      background: linear-gradient(90deg, #28a745, #20c997);
      height: 100%;
      width: 0%;
      transition: width 0.3s ease;
      border-radius: 10px;
    }

    .progress-text {
      font-weight: bold;
      color: #495057;
      margin-top: 5px;
    }

    .ean-scanner-section, .ean-list-section {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .ean-scanner-section h4, .ean-list-section h4 {
      margin: 0 0 15px 0;
      color: #495057;
    }

    .ean-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 8px 0;
      transition: all 0.3s ease;
    }

    .ean-item.checked {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    .ean-item.checked .ean-status {
      color: #155724;
    }

    .ean-item.non-tested {
      background: #fff3cd;
      border-color: #ffeaa7;
    }

    .ean-details {
      flex: 1;
    }

    .ean-code {
      font-family: monospace;
      font-weight: bold;
      color: #495057;
      font-size: 1.1em;
    }

    .ean-info {
      font-size: 0.9em;
      color: #6c757d;
      margin-top: 3px;
    }

    .ean-status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.9em;
    }

    .ean-status.pending {
      background: #fff3cd;
      color: #856404;
    }

    .ean-status.found {
      background: #d4edda;
      color: #155724;
    }

    .ean-status.non-tested {
      background: #fff3cd;
      color: #856404;
    }

    .validation-summary {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
    }

    .validation-summary.success {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    .validation-summary.warning {
      background: #fff3cd;
      border-color: #ffeaa7;
    }

    .validation-summary h4 {
      margin: 0 0 10px 0;
    }
    
    /* Am√©lioration responsive */
    @media (max-width: 768px) {
      .container {
        padding: 15px;
        margin: 5px;
      }
      
      .notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
        transform: translateY(-100px);
      }
      
      .notification.show {
        transform: translateY(0);
      }
      
      .button-row {
        flex-direction: column;
      }
      
      .button-row button {
        min-width: auto;
      }
      
      .radio-group {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .reference-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Matrice Contr√¥le Qualit√© - v2.1</h1>

    <div class="section" id="step1">
      <h3>1Ô∏è‚É£ Charger les donn√©es</h3>
      
      <!-- Mode d'emploi -->
      <div class="help-section">
        <h4>üìñ Mode d'emploi</h4>
        <div class="help-content">
          <div class="help-item">
            <span class="help-icon">üåê</span>
            <div class="help-text">
              <strong>Boutons "En ligne"</strong> : Chargent automatiquement les fichiers depuis Internet (recommand√©)
            </div>
          </div>
          <div class="help-item">
            <span class="help-icon">üìÅ</span>
            <div class="help-text">
              <strong>Boutons "Local"</strong> : Permettent de s√©lectionner vos propres fichiers depuis votre ordinateur ou votre smartphone
            </div>
          </div>
          <div class="help-item">
            <span class="help-icon">üöÄ</span>
            <div class="help-text">
              <strong>Utilisation recommand√©e</strong> : 
              1Ô∏è‚É£ Cliquez "üåê En ligne" pour la BDD 
              2Ô∏è‚É£ Puis "üåê En ligne" pour le BOOKING
            </div>
          </div>
        </div>
        
        <!-- Bouton de r√©initialisation du cache -->
        <div class="cache-reset-section">
          <button onclick="resetCache()" class="cache-reset-btn" title="Efface les fichiers sauvegard√©s et recommence">
            üóëÔ∏è Vider le cache
          </button>
          <small>Efface les fichiers sauvegard√©s pour recommencer</small>
        </div>
      </div>
      
      <!-- Inputs fichiers cach√©s -->
      <input type="file" id="csvFile" accept=".csv" style="display:none;" onchange="loadCSV()" />
      <input type="file" id="bookingFile" accept=".xlsx,.xls" style="display:none;" onchange="loadBookingFile()" />
      
      <!-- Statuts des fichiers -->
      <div class="files-status">
        <div class="file-status-item">
          <div class="file-status-header">
            <h4>üìä Base de Donn√©es (BDD)</h4>
            <div class="file-actions">
              <button onclick="loadOnlineCSV()" class="reload-btn" id="reloadBddBtn">üåê En ligne</button>
              <button onclick="document.getElementById('csvFile').click()" class="reload-btn">üìÅ Local</button>
            </div>
          </div>
          <div id="bddStatus" class="status-display">‚è≥ En attente...</div>
        </div>
        
        <div class="file-status-item">
          <div class="file-status-header">
            <h4>üìã Fichier de Booking</h4>
            <div class="file-actions">
              <button onclick="loadOnlineBooking()" class="reload-btn" id="reloadBookingBtn">üåê En ligne</button>
              <button onclick="document.getElementById('bookingFile').click()" class="reload-btn">üìÅ Local</button>
            </div>
          </div>
          <div id="bookingStatus" class="status-display">‚è≥ En attente...</div>
        </div>
      </div>
      
      <!-- Statut global et bouton de continuation -->
      <div class="global-status">
        <div id="globalStatus" class="global-status-display">
          <span class="status-indicator pending"></span>
          Fichiers manquants : BDD et BOOKING
        </div>
        <button onclick="proceedToBookingSelection()" id="continueBtn" disabled class="continue-button">
          ‚û°Ô∏è Continuer vers la s√©lection de booking
        </button>
      </div>
    </div>

    <div class="section hidden" id="step2">
      <h3>2Ô∏è‚É£ S√©lectionner un booking</h3>
      <div class="booking-selection">
        <h4>üîç Rechercher un booking</h4>
        <input type="text" id="bookingSearchInput" placeholder="Rechercher par num√©ro de booking..." onkeyup="filterBookings()" />
        <div id="bookingList" class="booking-list"></div>
      </div>
    </div>

    <div class="section hidden" id="step3">
      <h3>3Ô∏è‚É£ Organiser les r√©f√©rences du booking</h3>
      
      <div class="current-booking-info" id="currentBookingInfo">
        <!-- Informations du booking s√©lectionn√© -->
      </div>

      <div class="progress-section" id="bookingProgressSection">
        <h4>üìä Progression du booking</h4>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="bookingProgressFill">0%</div>
        </div>
        <div id="bookingProgressText">0 / 0 r√©f√©rences contr√¥l√©es</div>
      </div>

      <div class="reference-list">
        <h4>üìã R√©f√©rences √† contr√¥ler</h4>
        <div id="referencesList"></div>
      </div>

      <!-- SEULS BOUTONS PRINCIPAUX ICI -->
      <div class="button-row">
        <button onclick="startBookingControl()" id="startBookingButton">üöÄ Commencer le contr√¥le du booking</button>
        <button onclick="selectDifferentBooking()" style="background: #6c757d;">üîÑ Choisir un autre booking</button>
      </div>
    </div>

    <div class="section hidden" id="step4">
      <h3>4Ô∏è‚É£ Scanner un code-barres</h3>
      
      <div class="current-booking-info" id="currentControlInfo">
        <!-- Informations de contr√¥le en cours -->
      </div>

      <div class="button-row">
        <button id="scanButton" onclick="startCamera()">üì∑ Scanner en direct</button>
        <button id="stopButton" onclick="stopCamera()" style="display:none;">‚èπÔ∏è Arr√™ter</button>
        <button onclick="showProductList()">üìã Choisir dans la liste</button>
      </div>
      
      <div id="scannerContainer">
        <div class="scanner-overlay">
          <video id="video" playsinline></video>
          <div class="scanner-frame">
            <div class="scanner-corners corner-tl"></div>
            <div class="scanner-corners corner-tr"></div>
            <div class="scanner-corners corner-bl"></div>
            <div class="scanner-corners corner-br"></div>
          </div>
        </div>
        <div class="scan-instruction">Placez le code-barres dans le cadre</div>
      </div>
      
      <div id="productListContainer" style="display:none;">
        <h4>üîç Rechercher une r√©f√©rence</h4>
        <input type="text" id="searchInput" placeholder="Rechercher par r√©f√©rence, code, marque..." onkeyup="filterProducts()" />
        <div id="productList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; margin: 10px 0;"></div>
        <button onclick="hideProductList()" style="background: #6c757d;">‚ùå Fermer la liste</button>
      </div>
      
      <label>‚å®Ô∏è Ou saisir manuellement :</label>
      <input type="text" id="barcodeInput" placeholder="Entrer un code EAN..." />
      <button onclick="findProduct()">üîç Rechercher</button>
      
      <!-- NAVIGATION SIMPLIFI√âE S√âPAR√âE -->
      <div class="navigation-buttons">
        <button onclick="selectDifferentBooking()" style="background: #6c757d;">‚¨ÖÔ∏è Retour aux bookings</button>
      </div>
    </div>

    <div id="results" style="display:none;"></div>

    <div class="section hidden" id="step5">
      <h3>5Ô∏è‚É£ Contr√¥le Qualit√© - Carton</h3>
      
      <div class="product-info" id="selectedProductInfo">
        <!-- Informations du produit s√©lectionn√© -->
      </div>

      <div id="qualityControlSection">
        
        <!-- Shipping Mark -->
        <div class="quality-criterion">
          <div class="criterion-title">üì¶ Shipping Mark</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="shipping_mark" value="ok" onchange="updatePackageQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="shipping_mark" value="not_ok" onchange="updatePackageQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_shipping_mark" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_shipping_mark" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('shipping_mark')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_shipping_mark"></div>
          </div>
        </div>

        <!-- Etat du colis -->
        <div class="quality-criterion">
          <div class="criterion-title">üìã Etat du colis</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="package_condition" value="ok" onchange="updatePackageQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="package_condition" value="not_ok" onchange="updatePackageQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_package_condition" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_package_condition" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('package_condition')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_package_condition"></div>
          </div>
        </div>

        <!-- Bande de garantie -->
        <div class="quality-criterion">
          <div class="criterion-title">üîí Bande de garantie</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="warranty_seal" value="ok" onchange="updatePackageQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="warranty_seal" value="not_ok" onchange="updatePackageQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_warranty_seal" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_warranty_seal" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('warranty_seal')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_warranty_seal"></div>
          </div>
        </div>

      </div>

      <div class="button-row">
        <button onclick="proceedToProductControl()" id="packageValidateButton" disabled>‚û°Ô∏è Contr√¥ler le produit</button>
        <button onclick="skipToNextReference()" style="background: #ffc107; color: #000;">‚è≠Ô∏è R√©f√©rence suivante</button>
        <button onclick="resetQualityControl()" style="background: #6c757d;">üîÑ Recommencer</button>
      </div>
    </div>

    <div class="section hidden" id="step6">
      <h3>6Ô∏è‚É£ Contr√¥le Qualit√© - Produit</h3>
      
      <div class="product-info" id="productControlInfo">
        <!-- Informations du produit s√©lectionn√© -->
      </div>

      <div id="productQualityControlSection">
        
        <!-- Test du zip -->
        <div class="quality-criterion">
          <div class="criterion-title">ü§ê V√©rification zip </div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="zip_test" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="zip_test" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
            <label class="radio-option">
              <input type="radio" name="zip_test" value="not_applicable" onchange="updateProductQualityStatus()">
              ‚ûñ Non applicable
            </label>
          </div>
          <textarea class="comment-area" id="comment_zip_test" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_zip_test" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('zip_test')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_zip_test"></div>
          </div>
        </div>

        <!-- V√©rification boutonnage -->
        <div class="quality-criterion">
          <div class="criterion-title">üîò V√©rification boutonnage</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="button_check" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="button_check" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
            <label class="radio-option">
              <input type="radio" name="button_check" value="not_applicable" onchange="updateProductQualityStatus()">
              ‚ûñ Non applicable
            </label>
          </div>
          <textarea class="comment-area" id="comment_button_check" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_button_check" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('button_check')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_button_check"></div>
          </div>
        </div>

        <!-- Contr√¥le Coloris -->
        <div class="quality-criterion">
          <div class="criterion-title">üé® V√©rification Coloris</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="color_check" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="color_check" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_color_check" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_color_check" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('color_check')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_color_check"></div>
          </div>
        </div>

        <!-- V√©rification finition/coutures -->
        <div class="quality-criterion">
          <div class="criterion-title">‚úÇÔ∏è V√©rification finition/coutures</div>
          <div class="radio-group">
            <label class="radio-option ok">
              <input type="radio" name="finishing_check" value="ok" onchange="updateProductQualityStatus()">
              ‚úÖ OK
            </label>
            <label class="radio-option not-ok">
              <input type="radio" name="finishing_check" value="not_ok" onchange="updateProductQualityStatus()">
              ‚ùå PAS OK
            </label>
          </div>
          <textarea class="comment-area" id="comment_finishing_check" placeholder="Commentaire (optionnel)..."></textarea>
          <div class="photo-section">
            <div class="photo-upload">
              <input type="file" id="photoInput_finishing_check" accept="image/*" multiple>
              <button class="photo-button" onclick="addPhotos('finishing_check')">üì∑ Ajouter Photos</button>
            </div>
            <div class="photo-preview" id="photos_finishing_check"></div>
          </div>
        </div>

      </div>

      <div class="button-row">
        <button onclick="proceedToEanControl()" id="productValidateButton" disabled>‚û°Ô∏è Contr√¥ler les EAN de la r√©f√©rence</button>
        <button onclick="goBackToPackageControl()" style="background: #ffc107; color: #000;">‚¨ÖÔ∏è Retour carton</button>
        <button onclick="skipToNextReference()" style="background: #ff6b6b; color: white;">‚è≠Ô∏è R√©f√©rence suivante</button>
        <button onclick="resetQualityControl()" style="background: #6c757d;">üîÑ Recommencer</button>
      </div>
    </div>

    <div class="section hidden" id="step7">
      <h3>7Ô∏è‚É£ Contr√¥le EAN - R√©f√©rence</h3>
      
      <div class="product-info" id="eanControlInfo">
        <!-- Informations de la r√©f√©rence √† contr√¥ler -->
      </div>

      <div id="eanControlSection">
        <div class="ean-progress">
          <h4>üìä Progression du contr√¥le</h4>
          <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-text" id="progressText">0 / 0 EAN contr√¥l√©s</div>
        </div>

        <div class="ean-scanner-section">
          <h4>üîç Scanner les EAN de la r√©f√©rence</h4>
          <div class="button-row">
            <button id="eanScanButton" onclick="startEanScanner()">üì∑ Scanner EAN</button>
            <button id="eanStopButton" onclick="stopEanScanner()" style="display:none;">‚èπÔ∏è Arr√™ter</button>
          </div>
          
          <div id="eanScannerContainer" style="display:none;">
            <div class="scanner-overlay">
              <video id="eanVideo" playsinline></video>
              <div class="scanner-frame">
                <div class="scanner-corners corner-tl"></div>
                <div class="scanner-corners corner-tr"></div>
                <div class="scanner-corners corner-bl"></div>
                <div class="scanner-corners corner-br"></div>
              </div>
            </div>
            <div class="scan-instruction">Scanner les codes-barres de la r√©f√©rence</div>
          </div>
          
          <label>‚å®Ô∏è Ou saisir manuellement :</label>
          <input type="text" id="eanInput" placeholder="Scanner ou saisir un EAN de la r√©f√©rence..." />
          <button onclick="checkEanForReference()">üîç V√©rifier EAN</button>
        </div>

        <div class="ean-list-section">
          <h4>üìã Liste des EAN √† contr√¥ler</h4>
          <div id="eanList"></div>
        </div>

        <div id="eanValidationResult" style="display:none;"></div>
      </div>

      <div class="button-row">
        <button onclick="completeCurrentReference()" id="completeReferenceButton" style="background: #28a745;">‚úÖ Terminer cette r√©f√©rence</button>
        <button onclick="goBackToProductControl()" style="background: #ffc107; color: #000;">‚¨ÖÔ∏è Retour produit</button>
        <button onclick="skipToNextReference()" style="background: #ff6b6b; color: white;">‚è≠Ô∏è R√©f√©rence suivante</button>
        <button onclick="resetQualityControl()" style="background: #6c757d;">üîÑ Recommencer</button>
      </div>
    </div>

    <div class="section hidden" id="step8">
      <h3>8Ô∏è‚É£ Rapports</h3>
      
      <div class="current-booking-info" id="reportsBookingInfo">
        <!-- Informations du booking termin√© -->
      </div>

      <div class="button-row">
        <button onclick="generateIndividualReports()" style="background: #17a2b8;">üìÑ Rapports individuels (par r√©f√©rence)</button>
        <button onclick="generateGlobalBookingReport()" style="background: #dc3545;">üìä Rapport global du booking</button>
        <button onclick="startNewBooking()" style="background: #28a745;">üÜï Nouveau booking</button>
      </div>
    </div>

  </div>

  <script>
    // ================================================================================================
    // üìã VARIABLES GLOBALES DE L'APPLICATION
    // ================================================================================================
    
    // Variables pour le stockage des donn√©es
    let database = [];                  // Base de donn√©es des produits (BDD.csv)
    let bookingData = [];              // Donn√©es du fichier de booking (.xlsx)
    let availableBookings = [];        // Liste des bookings disponibles
    
    // Variables pour le contr√¥le qualit√©
    let currentProduct = null;         // Produit actuellement s√©lectionn√©
    let packageQualityResults = {};    // R√©sultats contr√¥le carton
    let productQualityResults = {};    // R√©sultats contr√¥le produit
    let criterionPhotos = {};          // Photos des crit√®res
    
    // Variables pour le contr√¥le des r√©f√©rences et EAN
    let currentReference = null;       // R√©f√©rence en cours de contr√¥le
    let referenceEanList = [];        // Liste des EAN de la r√©f√©rence
    let checkedEans = new Set();      // EAN v√©rifi√©s
    let nonTestedEans = new Set();    // EAN non test√©s
    
    // Variables pour la gestion des bookings
    let currentBooking = null;         // Booking actuellement s√©lectionn√©
    let bookingReferences = [];       // R√©f√©rences du booking en cours
    let currentReferenceIndex = 0;    // Index de la r√©f√©rence en cours
    let completedReferences = new Set(); // R√©f√©rences termin√©es
    let bookingQualityResults = {};   // R√©sultats de tout le booking

    // Variables pour le statut des fichiers
    let bddLoaded = false;            // √âtat du chargement de la BDD
    let bookingLoaded = false;        // √âtat du chargement du booking

    // ================================================================================================
    // üóëÔ∏è FONCTION DE R√âINITIALISATION DU CACHE
    // ================================================================================================

    function resetCache() {
      if (confirm("üóëÔ∏è √ätes-vous s√ªr de vouloir vider le cache ?\n\nCela effacera tous les fichiers sauvegard√©s et vous devrez les recharger.")) {
        try {
          // Arr√™ter tous les scanners actifs
          if (window.isScanning) window.stopCamera();
          if (window.isEanScanning) stopEanScanner();
          
          // Vider compl√®tement le cache localStorage
          window.StorageManager.clear();
          
          // R√©initialiser toutes les variables globales
          database = [];
          bookingData = [];
          availableBookings = [];
          currentProduct = null;
          packageQualityResults = {};
          productQualityResults = {};
          criterionPhotos = {};
          currentReference = null;
          referenceEanList = [];
          checkedEans.clear();
          nonTestedEans.clear();
          currentBooking = null;
          bookingReferences = [];
          currentReferenceIndex = 0;
          completedReferences.clear();
          bookingQualityResults = {};
          bddLoaded = false;
          bookingLoaded = false;
          
          // Remettre l'interface √† l'√©tat initial
          document.getElementById('step1').classList.remove('completed');
          document.getElementById('step1').classList.add('active');
          document.getElementById('step2').classList.add('hidden');
          document.getElementById('step2').classList.remove('active', 'completed');
          document.getElementById('step3').classList.add('hidden');
          document.getElementById('step3').classList.remove('active', 'completed');
          document.getElementById('step4').classList.add('hidden');
          document.getElementById('step4').classList.remove('active', 'completed');
          
          // R√©initialiser les statuts des fichiers
          updateBddStatus('loading', 'Cache vid√© - En attente...', false);
          updateBookingStatus('loading', 'Cache vid√© - En attente...', false);
          
          // Masquer les r√©sultats et vider les champs
          document.getElementById("results").style.display = "none";
          document.getElementById("barcodeInput").value = "";
          document.getElementById('productListContainer').style.display = 'none';
          
          // Remettre les statuts en "En attente"
          setTimeout(() => {
            updateBddStatus('loading', 'En attente...', false);
            updateBookingStatus('loading', 'En attente...', false);
            
            // Changer le texte pour indiquer l'attente
            document.getElementById('bddStatus').innerHTML = '‚è≥ En attente...';
            document.getElementById('bddStatus').className = 'status-display';
            document.getElementById('bookingStatus').innerHTML = '‚è≥ En attente...';
            document.getElementById('bookingStatus').className = 'status-display';
            
            // Retirer les classes des containers
            document.querySelector('#bddStatus').closest('.file-status-item').className = 'file-status-item';
            document.querySelector('#bookingStatus').closest('.file-status-item').className = 'file-status-item';
            
            updateGlobalStatus();
          }, 100);
          
          // Scroll vers le haut
          document.getElementById('step1').scrollIntoView({ behavior: 'smooth' });
          
          window.NotificationManager.show('Cache vid√© avec succ√®s! Vous pouvez recharger les fichiers.', 'success');
          
        } catch (error) {
          console.error('Erreur lors de la r√©initialisation:', error);
          window.NotificationManager.show('Erreur lors de la r√©initialisation du cache.', 'error');
        }
      }
    }

    // ================================================================================================
    // üîÑ FONCTIONS DE GESTION DU STATUT DES FICHIERS
    // ================================================================================================

    // Fonction pour mettre √† jour le statut global
    function updateGlobalStatus() {
      const globalStatus = document.getElementById('globalStatus');
      const continueBtn = document.getElementById('continueBtn');
      const step1 = document.getElementById('step1');
      
      if (bddLoaded && bookingLoaded) {
        globalStatus.innerHTML = `
          <span class="status-indicator success"></span>
          ‚úÖ Tous les fichiers sont charg√©s - Pr√™t √† continuer
        `;
        document.querySelector('.global-status').classList.add('ready');
        continueBtn.disabled = false;
        step1.classList.add('completed');
        window.NotificationManager.show('Tous les fichiers sont charg√©s! Vous pouvez continuer.', 'success');
      } else {
        const missing = [];
        if (!bddLoaded) missing.push('BDD');
        if (!bookingLoaded) missing.push('BOOKING');
        
        globalStatus.innerHTML = `
          <span class="status-indicator pending"></span>
          Fichiers manquants : ${missing.join(' et ')}
        `;
        document.querySelector('.global-status').classList.remove('ready');
        continueBtn.disabled = true;
        step1.classList.remove('completed');
      }
    }

    // Fonction pour mettre √† jour le statut BDD
    function updateBddStatus(status, message, showNotification = true) {
      const bddStatus = document.getElementById('bddStatus');
      const bddItem = bddStatus.closest('.file-status-item');
      
      // Nettoyer les classes pr√©c√©dentes
      bddItem.classList.remove('loaded', 'error');
      bddStatus.classList.remove('success', 'error', 'loading');
      
      switch (status) {
        case 'loading':
          bddStatus.innerHTML = `<span class="loading-spinner"></span>${message}`;
          bddStatus.classList.add('loading');
          bddLoaded = false;
          break;
        case 'success':
          bddStatus.innerHTML = `‚úÖ ${message}`;
          bddStatus.classList.add('success');
          bddItem.classList.add('loaded');
          bddLoaded = true;
          if (showNotification) window.NotificationManager.show(`BDD: ${message}`, 'success');
          break;
        case 'error':
          bddStatus.innerHTML = `‚ùå ${message}`;
          bddStatus.classList.add('error');
          bddItem.classList.add('error');
          bddLoaded = false;
          if (showNotification) window.NotificationManager.show(`Erreur BDD: ${message}`, 'error');
          break;
      }
      
      updateGlobalStatus();
    }

    // Fonction pour mettre √† jour le statut BOOKING
    function updateBookingStatus(status, message, showNotification = true) {
      const bookingStatus = document.getElementById('bookingStatus');
      const bookingItem = bookingStatus.closest('.file-status-item');
      
      // Nettoyer les classes pr√©c√©dentes
      bookingItem.classList.remove('loaded', 'error');
      bookingStatus.classList.remove('success', 'error', 'loading');
      
      switch (status) {
        case 'loading':
          bookingStatus.innerHTML = `<span class="loading-spinner"></span>${message}`;
          bookingStatus.classList.add('loading');
          bookingLoaded = false;
          break;
        case 'success':
          bookingStatus.innerHTML = `‚úÖ ${message}`;
          bookingStatus.classList.add('success');
          bookingItem.classList.add('loaded');
          bookingLoaded = true;
          if (showNotification) window.NotificationManager.show(`BOOKING: ${message}`, 'success');
          break;
        case 'error':
          bookingStatus.innerHTML = `‚ùå ${message}`;
          bookingStatus.classList.add('error');
          bookingItem.classList.add('error');
          bookingLoaded = false;
          if (showNotification) window.NotificationManager.show(`Erreur BOOKING: ${message}`, 'error');
          break;
      }
      
      updateGlobalStatus();
    }

    // Fonction pour continuer vers la s√©lection de booking
    function proceedToBookingSelection() {
      if (!bddLoaded || !bookingLoaded) {
        window.NotificationManager.show('Tous les fichiers doivent √™tre charg√©s avant de continuer.', 'warning');
        return;
      }
      
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.remove('hidden');
      document.getElementById('step2').classList.add('active');
      
      window.NotificationManager.show('Passage √† la s√©lection de booking!', 'success');
      document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
    }

    // Fonction pour valider les donn√©es
    function validateData(data, type) {
      if (!data || data.length === 0) {
        throw new Error(`Aucune donn√©e ${type} trouv√©e`);
      }
      
      if (type === 'csv' && data[0].length < 10) {
        throw new Error('Le fichier CSV ne contient pas assez de colonnes');
      }
      
      if (type === 'booking' && data[0].length < 14) {
        throw new Error('Le fichier booking ne contient pas assez de colonnes');
      }
      
      return true;
    }

    function loadCSV() {
      const file = document.getElementById('csvFile').files[0];
      if (!file) {
        window.NotificationManager.show("S√©lectionnez un fichier CSV.", 'warning');
        return;
      }
      
      updateBddStatus('loading', 'Chargement du fichier CSV local...');
      
      Papa.parse(file, {
        header: false,
        delimiter: ";",
        skipEmptyLines: true,
        complete: results => {
          try {
            validateData(results.data, 'csv');
            database = results.data.slice(1);
            
            // Sauvegarder dans le stockage local
            window.StorageManager.save('database', database);
            
            updateBddStatus('success', `${database.length} articles charg√©s depuis le fichier local`);
          } catch (error) {
            updateBddStatus('error', error.message);
          }
        },
        error: (error) => {
          updateBddStatus('error', 'Erreur lors du lecture du fichier CSV');
          console.error(error);
        }
      });
    }

    function loadOnlineCSV() {
      updateBddStatus('loading', 'Chargement de la base de donn√©es en ligne...');
      
      const alternativeUrls = [
        'https://cdn.jsdelivr.net/gh/rbmfinance1/26004@gh-pages/bdd.csv',
        'https://raw.githubusercontent.com/rbmfinance1/26004/gh-pages/bdd.csv',
        'https://rbmfinance1.github.io/26004/bdd.csv'
      ];
      
      async function tryUrls(urlIndex = 0) {
        if (urlIndex >= alternativeUrls.length) {
          updateBddStatus('error', 'Toutes les sources en ligne ont √©chou√©');
          showManualDownloadOption('bdd');
          return;
        }
        
        const currentUrl = alternativeUrls[urlIndex];
        
        try {
          const response = await fetch(currentUrl, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache',
            headers: {
              'Accept': 'text/csv,text/plain,*/*'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const csvData = await response.text();
          
          if (csvData.includes('<!DOCTYPE') || csvData.includes('<html>')) {
            throw new Error('Contenu HTML re√ßu au lieu de CSV');
          }
          
          if (csvData.trim().length < 10) {
            throw new Error('Fichier CSV vide ou trop court');
          }
          
          processCsvData(csvData);
          
        } catch (error) {
          console.warn(`Source BDD ${urlIndex + 1} √©chou√©e:`, error.message);
          tryUrls(urlIndex + 1);
        }
      }
      
      tryUrls(0);
    }

    function processCsvData(csvData) {
      try {
        Papa.parse(csvData, {
          header: false,
          delimiter: ";",
          skipEmptyLines: true,
          complete: results => {
            if (results.data && results.data.length > 1) {
              validateData(results.data, 'csv');
              database = results.data.slice(1);
              
              // Sauvegarder dans le stockage local
              window.StorageManager.save('database', database);
              
              updateBddStatus('success', `${database.length} articles charg√©s depuis la base en ligne`);
            } else {
              throw new Error('Fichier CSV vide ou invalide');
            }
          },
          error: (error) => {
            throw new Error('Erreur lors du traitement du fichier CSV');
          }
        });
      } catch (error) {
        updateBddStatus('error', error.message);
      }
    }

    function loadOnlineBooking() {
      if (!bddLoaded) {
        updateBookingStatus('error', 'Veuillez d\'abord charger la base de donn√©es CSV');
        return;
      }

      updateBookingStatus('loading', 'Chargement du fichier de booking en ligne...');
      
      const alternativeUrls = [
        'https://cdn.jsdelivr.net/gh/rbmfinance1/26004@gh-pages/booking.xlsx',
        'https://raw.githubusercontent.com/rbmfinance1/26004/gh-pages/booking.xlsx',
        'https://rbmfinance1.github.io/26004/booking.xlsx'
      ];
      
      async function tryBookingUrls(urlIndex = 0) {
        if (urlIndex >= alternativeUrls.length) {
          console.log('Toutes les sources de booking ont √©chou√©');
          updateBookingStatus('error', 'Toutes les sources en ligne ont √©chou√©');
          showManualDownloadOption('booking');
          return;
        }
        
        const currentUrl = alternativeUrls[urlIndex];
        console.log(`Tentative booking ${urlIndex + 1}:`, currentUrl);
        
        try {
          const response = await fetch(currentUrl, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache',
            headers: {
              'Accept': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,*/*'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const arrayBuffer = await response.arrayBuffer();
          
          if (arrayBuffer.byteLength < 100) {
            throw new Error('Fichier Excel vide ou trop court');
          }
          
          console.log('‚úÖ Chargement booking r√©ussi avec:', currentUrl);
          processBookingData(arrayBuffer, true);
          
        } catch (error) {
          console.log(`Source booking ${urlIndex + 1} √©chou√©e:`, error.message);
          tryBookingUrls(urlIndex + 1);
        }
      }
      
      tryBookingUrls(0);
    }

    function loadBookingFile() {
      const file = document.getElementById('bookingFile').files[0];
      if (!file) {
        window.NotificationManager.show("S√©lectionnez un fichier Excel.", 'warning');
        return;
      }
      
      if (!bddLoaded) {
        updateBookingStatus('error', 'Veuillez d\'abord charger la base de donn√©es CSV');
        window.NotificationManager.show("Veuillez d'abord charger la base de donn√©es CSV.", 'warning');
        return;
      }

      updateBookingStatus('loading', 'Chargement du fichier de booking local...');
      
      const reader = new FileReader();
      reader.onload = function(e) {
        processBookingData(e.target.result, false);
      };
      
      reader.readAsArrayBuffer(file);
    }

    function processBookingData(arrayBuffer, isOnline = false) {
      try {
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        validateData(jsonData, 'booking');
        
        bookingData = jsonData.slice(1);
        
        // Sauvegarder dans le stockage local
        window.StorageManager.save('bookingData', bookingData);
        
        extractBookings();
        
        const source = isOnline ? 'depuis le fichier en ligne' : 'depuis le fichier local';
        updateBookingStatus('success', `${bookingData.length} lignes charg√©es ${source} - ${availableBookings.length} bookings trouv√©s`);
        
        if (availableBookings.length === 0) {
          updateBookingStatus('error', 'Aucun booking trouv√© dans le fichier');
        } else {
          // Si on a √† la fois la BDD et le booking, afficher les bookings
          if (bddLoaded && bookingLoaded) {
            displayBookings();
          }
        }
        
      } catch (error) {
        console.error('Erreur traitement booking:', error);
        updateBookingStatus('error', 'Erreur lors du traitement du fichier: ' + error.message);
      }
    }

    function showManualDownloadOption(fileType) {
      const statusElement = fileType === 'bdd' ? document.getElementById('bddStatus') : document.getElementById('bookingStatus');
      const fileName = fileType === 'bdd' ? 'bdd.csv' : 'booking.xlsx';
      const fileUrl = fileType === 'bdd' ? 
        'https://rbmfinance1.github.io/26004/bdd.csv' : 
        'https://rbmfinance1.github.io/26004/booking.xlsx';
      
      const manualDownload = `
        <div class="manual-download">
          <h5>üì• T√©l√©chargement manuel requis</h5>
          <p>Le chargement automatique a √©chou√©. T√©l√©chargez le fichier manuellement :</p>
          <div class="download-links">
            <a href="${fileUrl}" download="${fileName}" class="download-link">
              üì• T√©l√©charger ${fileName}
            </a>
          </div>
          <small>Apr√®s t√©l√©chargement, utilisez le bouton "üìÅ Local" correspondant.</small>
        </div>
      `;
      
      statusElement.innerHTML = `‚ùå Chargement en ligne √©chou√©${manualDownload}`;
    }

    function extractBookings() {
      const bookingsSet = new Set();
      const bookingsWithCounts = {};
      
      bookingData.forEach(row => {
        const bookingNumber = row[BOOKING_COL_BOOKING_NUMBER];
        const codeArticle = row[BOOKING_COL_CODE_ARTICLE];
        
        if (bookingNumber && codeArticle) {
          const bookingStr = String(bookingNumber).trim();
          bookingsSet.add(bookingStr);
          
          if (!bookingsWithCounts[bookingStr]) {
            bookingsWithCounts[bookingStr] = new Set();
          }
          bookingsWithCounts[bookingStr].add(String(codeArticle).trim());
        }
      });
      
      availableBookings = Array.from(bookingsSet).map(booking => ({
        number: booking,
        referenceCount: bookingsWithCounts[booking].size,
        references: Array.from(bookingsWithCounts[booking])
      })).sort((a, b) => a.number.localeCompare(b.number));
      
      // Sauvegarder dans le stockage local
      window.StorageManager.save('availableBookings', availableBookings);
    }

    function extractBookingReferences() {
      const codesArticles = bookingData
        .filter(row => String(row[BOOKING_COL_BOOKING_NUMBER]).trim() === currentBooking.number)
        .map(row => String(row[BOOKING_COL_CODE_ARTICLE]).trim())
        .filter(code => code);
      
      bookingReferences = [];
      const uniqueRefs = new Set();
      
      codesArticles.forEach(codeArticle => {
        const matchingItems = database.filter(item => item[COL_CODE] === codeArticle);
        
        matchingItems.forEach(item => {
          const ref = item[COL_REF];
          if (ref && !uniqueRefs.has(ref)) {
            uniqueRefs.add(ref);
            bookingReferences.push({
              reference: ref,
              codeArticle: codeArticle,
              marque: item[COL_MARQUE],
              items: database.filter(dbItem => dbItem[COL_REF] === ref)
            });
          }
        });
      });
      
      currentReferenceIndex = 0;
      completedReferences.clear();
      
      // Sauvegarder les r√©f√©rences du booking
      window.StorageManager.save('bookingReferences', bookingReferences);
    }

    function displayBookingReferences() {
      const referencesList = document.getElementById('referencesList');
      
      if (bookingReferences.length === 0) {
        referencesList.innerHTML = '<div class="no-results">Aucune r√©f√©rence trouv√©e pour ce booking</div>';
        return;
      }
      
      referencesList.innerHTML = bookingReferences.map((ref, index) => {
        const isCompleted = completedReferences.has(ref.reference);
        const isCurrent = index === currentReferenceIndex;
        
        let statusClass = 'pending';
        let statusText = 'En attente';
        let statusIndicator = 'pending';
        
        if (isCompleted) {
          statusClass = 'completed';
          statusText = 'Termin√© ‚úÖ';
          statusIndicator = 'success';
        } else if (isCurrent) {
          statusClass = 'current';
          statusText = 'En cours üîÑ';
          statusIndicator = 'pending';
        }
        
        return `
          <div class="reference-item ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''}">
            <div class="reference-info">
              <div class="reference-code">${ref.reference}</div>
              <div class="reference-details">
                Code: ${ref.codeArticle} | Marque: ${ref.marque} | ${ref.items.length} variante${ref.items.length > 1 ? 's' : ''}
              </div>
            </div>
            <div class="reference-status ${statusClass}">
              <span class="status-indicator ${statusIndicator}"></span>
              ${statusText}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateBookingProgress() {
      const total = bookingReferences.length;
      const completed = completedReferences.size;
      const percentage = total > 0 ? (completed / total) * 100 : 0;
      
      document.getElementById('bookingProgressFill').style.width = percentage + '%';
      document.getElementById('bookingProgressFill').textContent = Math.round(percentage) + '%';
      document.getElementById('bookingProgressText').textContent = 
        `${completed} / ${total} r√©f√©rences contr√¥l√©es`;
    }

    function displayBookings() {
      const bookingList = document.getElementById('bookingList');
      
      if (availableBookings.length === 0) {
        bookingList.innerHTML = '<div class="no-results">Aucun booking trouv√©</div>';
        return;
      }
      
      bookingList.innerHTML = availableBookings.map(booking => 
        `<div class="booking-item" onclick="selectBooking('${booking.number}')">
          <div class="booking-ref">
            <span class="status-indicator pending"></span>
            ${booking.number}
          </div>
          <div class="booking-details">
            ${booking.referenceCount} r√©f√©rence${booking.referenceCount > 1 ? 's' : ''} √† contr√¥ler
          </div>
        </div>`
      ).join('');
    }

    function filterBookings() {
      const searchTerm = document.getElementById('bookingSearchInput').value.toLowerCase();
      
      if (searchTerm === '') {
        displayBookings();
        return;
      }
      
      const filteredBookings = availableBookings.filter(booking => 
        booking.number.toLowerCase().includes(searchTerm)
      );
      
      const bookingList = document.getElementById('bookingList');
      
      if (filteredBookings.length === 0) {
        bookingList.innerHTML = '<div class="no-results">Aucun booking trouv√©</div>';
        return;
      }
      
      bookingList.innerHTML = filteredBookings.map(booking => 
        `<div class="booking-item" onclick="selectBooking('${booking.number}')">
          <div class="booking-ref">
            <span class="status-indicator pending"></span>
            ${booking.number}
          </div>
          <div class="booking-details">
            ${booking.referenceCount} r√©f√©rence${booking.referenceCount > 1 ? 's' : ''} √† contr√¥ler
          </div>
        </div>`
      ).join('');
    }

    function selectBooking(bookingNumber) {
      currentBooking = availableBookings.find(b => b.number === bookingNumber);
      if (!currentBooking) {
        window.NotificationManager.show("Booking introuvable", 'error');
        return;
      }
      
      // Sauvegarder le booking s√©lectionn√©
      window.StorageManager.save('currentBooking', currentBooking);
      
      extractBookingReferences();
      
      document.getElementById("currentBookingInfo").innerHTML = `
        <h4>üìã Booking s√©lectionn√© : ${currentBooking.number}</h4>
        <strong>R√©f√©rences √† contr√¥ler :</strong> ${bookingReferences.length}<br/>
        <strong>Statut :</strong> <span class="status-indicator success"></span>Pr√™t pour le contr√¥le
      `;
      
      document.getElementById('step2').classList.remove('active');
      document.getElementById('step2').classList.add('completed');
      document.getElementById('step3').classList.remove('hidden');
      document.getElementById('step3').classList.add('active');
      
      displayBookingReferences();
      updateBookingProgress();
      
      window.NotificationManager.show(`Booking ${bookingNumber} s√©lectionn√©!`, 'success');
      
      document.getElementById('step3').scrollIntoView({ behavior: 'smooth' });
    }

    function startBookingControl() {
      if (bookingReferences.length === 0) {
        window.NotificationManager.show("Aucune r√©f√©rence √† contr√¥ler dans ce booking", 'error');
        return;
      }
      
      document.getElementById('step3').classList.remove('active');
      document.getElementById('step3').classList.add('completed');
      document.getElementById('step4').classList.remove('hidden');
      document.getElementById('step4').classList.add('active');
      
      updateCurrentControlInfo();
      
      window.NotificationManager.show("Contr√¥le du booking commenc√©!", 'success');
      
      document.getElementById('step4').scrollIntoView({ behavior: 'smooth' });
    }

    function updateCurrentControlInfo() {
      const currentRef = bookingReferences[currentReferenceIndex];
      if (!currentRef) return;
      
      document.getElementById("currentControlInfo").innerHTML = `
        <h4>üîç Contr√¥le en cours</h4>
        <strong>Booking :</strong> ${currentBooking.number} | 
        <strong>R√©f√©rence :</strong> ${currentRef.reference} (${currentReferenceIndex + 1}/${bookingReferences.length})<br/>
        <strong>Code :</strong> ${currentRef.codeArticle} | 
        <strong>Marque :</strong> ${currentRef.marque}
      `;
    }

    function selectDifferentBooking() {
      // Arr√™ter les scanners s'ils sont actifs
      if (window.isScanning) window.stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      // Retourner √† la s√©lection de booking depuis n'importe quelle √©tape
      document.getElementById('step3').classList.remove('active');
      document.getElementById('step3').classList.add('hidden');
      document.getElementById('step4').classList.remove('active');
      document.getElementById('step4').classList.add('hidden');
      document.getElementById('step5').classList.remove('active');
      document.getElementById('step5').classList.add('hidden');
      document.getElementById('step6').classList.remove('active');
      document.getElementById('step6').classList.add('hidden');
      document.getElementById('step7').classList.remove('active');
      document.getElementById('step7').classList.add('hidden');
      
      document.getElementById('step2').classList.add('active');
      document.getElementById('step2').classList.remove('completed');
      
      // R√©initialiser les variables du booking
      currentBooking = null;
      bookingReferences = [];
      currentReferenceIndex = 0;
      completedReferences.clear();
      currentProduct = null;
      
      // Nettoyer le stockage local
      window.StorageManager.remove('currentBooking');
      window.StorageManager.remove('bookingReferences');
      
      // Masquer les r√©sultats de recherche
      document.getElementById("results").style.display = "none";
      document.getElementById("barcodeInput").value = "";
      
      window.NotificationManager.show('Retour √† la s√©lection de booking', 'info');
      
      document.getElementById('step2').scrollIntoView({ behavior: 'smooth' });
    }

    function findProduct() {
      if (window.isScanning) window.stopCamera();
      
      const code = document.getElementById("barcodeInput").value.trim();
      if (!code) {
        window.NotificationManager.show("Veuillez entrer un code EAN", 'warning');
        return;
      }
      
      if (database.length === 0) {
        window.NotificationManager.show("Veuillez d'abord charger un fichier CSV", 'warning');
        return;
      }
      
      if (currentBooking && bookingReferences.length > 0) {
        const currentRef = bookingReferences[currentReferenceIndex];
        if (currentRef) {
          const result = currentRef.items.find(item => item[COL_EAN] === code);
          
          if (result) {
            proceedWithProduct(result);
          } else {
            const otherRefProduct = database.find(item => item[COL_EAN] === code);
            if (otherRefProduct) {
              const belongsToBooking = bookingReferences.some(ref => 
                ref.items.some(item => item[COL_EAN] === code)
              );
              
              if (belongsToBooking) {
                window.NotificationManager.show(
                  `Ce produit appartient √† une autre r√©f√©rence du booking.\n\nR√©f√©rence attendue: ${currentRef.reference}\nR√©f√©rence du produit: ${otherRefProduct[COL_REF]}`, 
                  'error'
                );
              } else {
                window.NotificationManager.show(
                  `Ce produit n'appartient pas au booking ${currentBooking.number}.\n\nR√©f√©rence du produit: ${otherRefProduct[COL_REF]}`, 
                  'error'
                );
              }
            } else {
              window.NotificationManager.show("Code EAN non trouv√© dans la base de donn√©es", 'error');
            }
          }
        }
      } else {
        const result = database.find(row => row[COL_EAN] === code);
        if (result) {
          proceedWithProduct(result);
        } else {
          window.NotificationManager.show("Code EAN non trouv√© dans la base de donn√©es", 'error');
        }
      }
    }

    function proceedWithProduct(result) {
      currentProduct = result;
      const rd = document.getElementById("results");
      rd.style.display = "block";
      rd.innerHTML = `
        <div class="item" style="background: linear-gradient(135deg, #d4edda, #c3e6cb); border: 1px solid #28a745; border-radius: 10px;">
          <strong>‚úÖ Article trouv√© !</strong><br/><br/>
          <strong>R√©f :</strong> ${result[COL_REF] || 'N/A'}<br/>
          <strong>Code Article :</strong> ${result[COL_CODE] || 'N/A'}<br/>
          <strong>Marque :</strong> ${result[COL_MARQUE] || 'N/A'}<br/>
          <strong>Couleur :</strong> ${result[COL_COULEUR] || 'N/A'}<br/>
          <strong>Taille :</strong> ${result[COL_TAILLE] || 'N/A'}<br/>
          <strong>EAN :</strong> ${result[COL_EAN] || 'N/A'}<br/><br/>
          <button onclick='startQualityControl()' style="background: linear-gradient(135deg, #28a745, #20c997);">üîç Commencer le contr√¥le qualit√©</button>
        </div>`;
      rd.scrollIntoView({ behavior: 'smooth' });
      
      window.NotificationManager.show("Article trouv√©! Pr√™t pour le contr√¥le qualit√©.", 'success');
    }

    function showProductList() {
      if (window.isScanning) window.stopCamera();
      
      if (database.length === 0) {
        window.NotificationManager.show("Veuillez d'abord charger un fichier CSV", 'warning');
        return;
      }
      
      let productsToShow = database;
      if (currentBooking && bookingReferences.length > 0) {
        const currentRef = bookingReferences[currentReferenceIndex];
        if (currentRef) {
          productsToShow = currentRef.items;
        }
      }
      
      document.getElementById('productListContainer').style.display = 'block';
      document.getElementById('searchInput').value = '';
      displayProducts(productsToShow);
      
      document.getElementById('productListContainer').scrollIntoView({ behavior: 'smooth' });
      
      setTimeout(() => {
        document.getElementById('searchInput').focus();
      }, 300);
    }

    function hideProductList() {
      document.getElementById('productListContainer').style.display = 'none';
    }

    function displayProducts(products) {
      const productList = document.getElementById('productList');
      
      if (products.length === 0) {
        productList.innerHTML = '<div class="no-results">Aucun produit trouv√©</div>';
        return;
      }
      
      productList.innerHTML = products.slice(0, 100).map((item, index) => 
        `<div class="product-item" onclick="selectProduct(${products === database ? database.indexOf(item) : index}, ${products !== database})">
          <div class="product-ref">${item[COL_REF] || 'N/A'}</div>
          <div class="product-details">
            ${item[COL_CODE] || 'N/A'} | ${item[COL_MARQUE] || 'N/A'} | 
            Taille: ${item[COL_TAILLE] || 'N/A'} | Couleur: ${item[COL_COULEUR] || 'N/A'}
          </div>
        </div>`
      ).join('');
      
      if (products.length > 100) {
        productList.innerHTML += '<div class="no-results">... et ' + (products.length - 100) + ' autres r√©sultats. Affinez votre recherche.</div>';
      }
    }

    function filterProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      let baseProducts = database;
      if (currentBooking && bookingReferences.length > 0) {
        const currentRef = bookingReferences[currentReferenceIndex];
        if (currentRef) {
          baseProducts = currentRef.items;
        }
      }
      
      if (searchTerm === '') {
        displayProducts(baseProducts);
        return;
      }
      
      const filteredProducts = baseProducts.filter(item => {
        const ref = (item[COL_REF] || '').toLowerCase();
        const code = (item[COL_CODE] || '').toLowerCase();
        const marque = (item[COL_MARQUE] || '').toLowerCase();
        const couleur = (item[COL_COULEUR] || '').toLowerCase();
        const taille = (item[COL_TAILLE] || '').toLowerCase();
        const ean = (item[COL_EAN] || '').toLowerCase();
        
        return ref.includes(searchTerm) || 
               code.includes(searchTerm) || 
               marque.includes(searchTerm) || 
               couleur.includes(searchTerm) || 
               taille.includes(searchTerm) ||
               ean.includes(searchTerm);
      });
      
      displayProducts(filteredProducts);
    }

    function selectProduct(index, isFromCurrentRef = false) {
      let selectedItem;
      
      if (isFromCurrentRef && currentBooking && bookingReferences.length > 0) {
        const currentRef = bookingReferences[currentReferenceIndex];
        selectedItem = currentRef.items[index];
      } else {
        selectedItem = database[index];
      }
      
      proceedWithProduct(selectedItem);
      hideProductList();
      
      document.getElementById("barcodeInput").value = selectedItem[COL_EAN] || '';
      
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
    }

    // ================================================================================================
    // üîß FONCTIONS DE CONTR√îLE QUALIT√â - √âTAPES 5, 6, 7
    // ================================================================================================

    function startQualityControl() {
      // Arr√™ter les scanners actifs
      if (window.isScanning) window.stopCamera();
      
      if (!currentProduct) return;

      // Masquer la section de r√©sultats
      document.getElementById("results").style.display = "none";

      // Afficher les informations du produit
      const productInfoHtml = `
        <h4>üì¶ Produit √† contr√¥ler</h4>
        <strong>R√©f :</strong> ${currentProduct[COL_REF] || 'N/A'} | 
        <strong>Code :</strong> ${currentProduct[COL_CODE] || 'N/A'} | 
        <strong>Marque :</strong> ${currentProduct[COL_MARQUE] || 'N/A'}<br/>
        <strong>Couleur :</strong> ${currentProduct[COL_COULEUR] || 'N/A'} | 
        <strong>Taille :</strong> ${currentProduct[COL_TAILLE] || 'N/A'} | 
        <strong>EAN :</strong> ${currentProduct[COL_EAN] || 'N/A'}
      `;
      
      document.getElementById("selectedProductInfo").innerHTML = productInfoHtml;

      // Afficher la section de contr√¥le qualit√© carton
      document.getElementById("step5").classList.remove("hidden");
      document.getElementById("step5").classList.add("active");
      document.getElementById("step4").classList.remove("active");
      document.getElementById("step4").classList.add("completed");

      // R√©initialiser les contr√¥les
      resetQualityControls();

      // Scroll vers la section de contr√¥le
      document.getElementById("step5").scrollIntoView({ behavior: 'smooth' });
      
      window.NotificationManager.show("Contr√¥le qualit√© commenc√©!", 'success');
    }

    function resetQualityControls() {
      // R√©initialiser tous les boutons radio
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.checked = false;
      });

      // Vider tous les commentaires
      document.querySelectorAll('.comment-area').forEach(textarea => {
        textarea.value = '';
      });

      // Vider tous les inputs de fichiers
      document.querySelectorAll('input[type="file"]').forEach(fileInput => {
        fileInput.value = '';
      });

      // R√©initialiser les photos
      criterionPhotos = {};
      initializePhotoContainers();
      
      // Vider tous les conteneurs de photos
      document.querySelectorAll('.photo-preview').forEach(container => {
        container.innerHTML = '';
      });

      // R√©initialiser les objets des r√©sultats
      packageQualityResults = {};
      productQualityResults = {};

      // D√©sactiver les boutons de validation
      document.getElementById('packageValidateButton').disabled = true;
      if (document.getElementById('productValidateButton')) {
        document.getElementById('productValidateButton').disabled = true;
      }
    }

    function updatePackageQualityStatus() {
      // V√©rifier si tous les crit√®res du carton sont remplis
      const shippingMark = document.querySelector('input[name="shipping_mark"]:checked');
      const packageCondition = document.querySelector('input[name="package_condition"]:checked');
      const warrantySeal = document.querySelector('input[name="warranty_seal"]:checked');

      // Activer le bouton si tous les crit√®res sont √©valu√©s
      const allChecked = shippingMark && packageCondition && warrantySeal;
      document.getElementById('packageValidateButton').disabled = !allChecked;

      // Mettre √† jour l'objet des r√©sultats du carton
      if (allChecked) {
        packageQualityResults = {
          shipping_mark: {
            status: shippingMark.value,
            comment: document.getElementById('comment_shipping_mark').value,
            photos: criterionPhotos['shipping_mark'] || []
          },
          package_condition: {
            status: packageCondition.value,
            comment: document.getElementById('comment_package_condition').value,
            photos: criterionPhotos['package_condition'] || []
          },
          warranty_seal: {
            status: warrantySeal.value,
            comment: document.getElementById('comment_warranty_seal').value,
            photos: criterionPhotos['warranty_seal'] || []
          }
        };
      }
    }

    function updateProductQualityStatus() {
      // V√©rifier si tous les crit√®res du produit sont remplis
      const zipTest = document.querySelector('input[name="zip_test"]:checked');
      const buttonCheck = document.querySelector('input[name="button_check"]:checked');
      const colorCheck = document.querySelector('input[name="color_check"]:checked');
      const finishingCheck = document.querySelector('input[name="finishing_check"]:checked');

      // Activer le bouton si tous les crit√®res sont √©valu√©s
      const allChecked = zipTest && buttonCheck && colorCheck && finishingCheck;
      document.getElementById('productValidateButton').disabled = !allChecked;

      // Mettre √† jour l'objet des r√©sultats du produit
      if (allChecked) {
        productQualityResults = {
          zip_test: {
            status: zipTest.value,
            comment: document.getElementById('comment_zip_test').value,
            photos: criterionPhotos['zip_test'] || []
          },
          button_check: {
            status: buttonCheck.value,
            comment: document.getElementById('comment_button_check').value,
            photos: criterionPhotos['button_check'] || []
          },
          color_check: {
            status: colorCheck.value,
            comment: document.getElementById('comment_color_check').value,
            photos: criterionPhotos['color_check'] || []
          },
          finishing_check: {
            status: finishingCheck.value,
            comment: document.getElementById('comment_finishing_check').value,
            photos: criterionPhotos['finishing_check'] || []
          }
        };
      }
    }

    function proceedToProductControl() {
      // Arr√™ter les scanners actifs
      if (window.isScanning) window.stopCamera();
      
      updatePackageQualityStatus();
      
      // Passer √† l'√©tape 6 (contr√¥le produit)
      document.getElementById("step5").classList.remove("active");
      document.getElementById("step5").classList.add("completed");
      
      // Copier les informations du produit dans la section produit
      const productInfoHtml = `
        <h4>üëï Contr√¥le du produit</h4>
        <strong>R√©f :</strong> ${currentProduct[COL_REF] || 'N/A'} | 
        <strong>Code :</strong> ${currentProduct[COL_CODE] || 'N/A'} | 
        <strong>Marque :</strong> ${currentProduct[COL_MARQUE] || 'N/A'}<br/>
        <strong>Couleur :</strong> ${currentProduct[COL_COULEUR] || 'N/A'} | 
        <strong>Taille :</strong> ${currentProduct[COL_TAILLE] || 'N/A'} | 
        <strong>EAN :</strong> ${currentProduct[COL_EAN] || 'N/A'}
      `;
      
      document.getElementById("productControlInfo").innerHTML = productInfoHtml;
      
      document.getElementById("step6").classList.remove("hidden");
      document.getElementById("step6").classList.add("active");

      // Scroll vers la section de contr√¥le produit
      document.getElementById("step6").scrollIntoView({ behavior: 'smooth' });
      
      window.NotificationManager.show("Passage au contr√¥le du produit!", 'success');
    }

    function goBackToPackageControl() {
      // Retourner √† l'√©tape 5 (contr√¥le carton)
      document.getElementById("step6").classList.remove("active");
      document.getElementById("step6").classList.add("hidden");
      document.getElementById("step7").classList.remove("active");
      document.getElementById("step7").classList.add("hidden");
      
      document.getElementById("step5").classList.add("active");
      document.getElementById("step5").classList.remove("completed");

      // Scroll vers la section de contr√¥le carton
      document.getElementById("step5").scrollIntoView({ behavior: 'smooth' });
      
      window.NotificationManager.show("Retour au contr√¥le du carton", 'info');
    }

    function proceedToEanControl() {
      updateProductQualityStatus();
      
      if (!currentProduct || !currentProduct[COL_REF]) {
        window.NotificationManager.show("Impossible de r√©cup√©rer la r√©f√©rence du produit", 'error');
        return;
      }

      currentReference = currentProduct[COL_REF];
      
      // Trouver tous les EAN de cette r√©f√©rence
      referenceEanList = database.filter(item => item[COL_REF] === currentReference);
      checkedEans.clear();
      nonTestedEans.clear();

      if (referenceEanList.length === 0) {
        window.NotificationManager.show("Aucun EAN trouv√© pour cette r√©f√©rence", 'error');
        return;
      }

      // Passer √† l'√©tape 7 (contr√¥le EAN)
      document.getElementById("step6").classList.remove("active");
      document.getElementById("step6").classList.add("completed");
      
      // Afficher les informations de la r√©f√©rence
      const eanInfoHtml = `
        <h4>üìã Contr√¥le des EAN</h4>
        <strong>R√©f√©rence :</strong> ${currentReference}<br/>
        <strong>Nombre d'EAN √† contr√¥ler :</strong> ${referenceEanList.length}<br/>
        <small>V√©rifiez que tous les codes EAN de cette r√©f√©rence sont pr√©sents physiquement</small>
      `;
      
      document.getElementById("eanControlInfo").innerHTML = eanInfoHtml;
      
      document.getElementById("step7").classList.remove("hidden");
      document.getElementById("step7").classList.add("active");

      // Initialiser la liste des EAN
      displayEanList();
      updateEanProgress();

      // Scroll vers la section de contr√¥le EAN
      document.getElementById("step7").scrollIntoView({ behavior: 'smooth' });
      
      window.NotificationManager.show("Passage au contr√¥le des EAN!", 'success');
    }

    function goBackToProductControl() {
      // Retourner √† l'√©tape 6 (contr√¥le produit)
      document.getElementById("step7").classList.remove("active");
      document.getElementById("step7").classList.add("hidden");
      
      document.getElementById("step6").classList.add("active");
      document.getElementById("step6").classList.remove("completed");

      // Arr√™ter le scanner EAN s'il est en cours
      if (window.isEanScanning) stopEanScanner();

      // Scroll vers la section de contr√¥le produit
      document.getElementById("step6").scrollIntoView({ behavior: 'smooth' });
      
      window.NotificationManager.show("Retour au contr√¥le du produit", 'info');
    }

    // ================================================================================================
    // üì∏ GESTION DES PHOTOS
    // ================================================================================================

    // Fonction pour ajouter des photos √† un crit√®re
    function addPhotos(criterionName) {
      const fileInput = document.getElementById(`photoInput_${criterionName}`);
      const files = fileInput.files;
      
      if (!files || files.length === 0) {
        window.NotificationManager.show("Veuillez s√©lectionner au moins une photo", 'warning');
        return;
      }

      // Initialiser le tableau de photos pour ce crit√®re si n√©cessaire
      if (!criterionPhotos[criterionName]) {
        criterionPhotos[criterionName] = [];
      }

      // Traiter chaque fichier s√©lectionn√©
      Array.from(files).forEach(file => {
        // V√©rifier le type de fichier
        if (!file.type.startsWith('image/')) {
          window.NotificationManager.show(`Le fichier "${file.name}" n'est pas une image valide`, 'error');
          return;
        }

        // V√©rifier la taille (limite √† 5MB)
        if (file.size > 5 * 1024 * 1024) {
          window.NotificationManager.show(`Le fichier "${file.name}" est trop volumineux (max 5MB)`, 'error');
          return;
        }

        // Lire et convertir le fichier en base64
        const reader = new FileReader();
        reader.onload = function(e) {
          const photoData = {
            name: file.name,
            size: file.size,
            type: file.type,
            data: e.target.result, // Base64
            timestamp: new Date().toLocaleString('fr-FR')
          };

          criterionPhotos[criterionName].push(photoData);
          displayPhotos(criterionName);
          window.NotificationManager.show(`Photo "${file.name}" ajout√©e avec succ√®s`, 'success');
        };

        reader.onerror = function() {
          window.NotificationManager.show(`Erreur lors de la lecture du fichier "${file.name}"`, 'error');
        };

        reader.readAsDataURL(file);
      });

      // Vider l'input file apr√®s traitement
      fileInput.value = '';
    }

    // Fonction pour afficher les photos d'un crit√®re
    function displayPhotos(criterionName) {
      const photosContainer = document.getElementById(`photos_${criterionName}`);
      const photos = criterionPhotos[criterionName] || [];

      if (photos.length === 0) {
        photosContainer.innerHTML = '';
        return;
      }

      photosContainer.innerHTML = photos.map((photo, index) => `
        <div class="photo-item">
          <img src="${photo.data}" alt="${photo.name}" />
          <button class="photo-remove" onclick="removePhoto('${criterionName}', ${index})" title="Supprimer cette photo">
            √ó
          </button>
          <div class="photo-timestamp">${photo.timestamp}</div>
        </div>
      `).join('');
    }

    // Fonction pour supprimer une photo
    function removePhoto(criterionName, photoIndex) {
      if (!criterionPhotos[criterionName]) return;

      if (confirm("üóëÔ∏è √ätes-vous s√ªr de vouloir supprimer cette photo ?")) {
        criterionPhotos[criterionName].splice(photoIndex, 1);
        displayPhotos(criterionName);
        
        // Vibration de confirmation si support√©e
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }
        
        window.NotificationManager.show("Photo supprim√©e avec succ√®s", 'success');
      }
    }

    // Fonction pour initialiser tous les conteneurs de photos
    function initializePhotoContainers() {
      const criterionNames = [
        'shipping_mark', 'package_condition', 'warranty_seal',
        'zip_test', 'button_check', 'color_check', 'finishing_check'
      ];

      criterionNames.forEach(criterionName => {
        if (!criterionPhotos[criterionName]) {
          criterionPhotos[criterionName] = [];
        }
      });
    }

    // ================================================================================================
    // üìã CONTR√îLE EAN - √âTAPE 7
    // ================================================================================================

    function displayEanList() {
      const eanList = document.getElementById('eanList');
      
      eanList.innerHTML = referenceEanList.map((item, index) => {
        const isChecked = checkedEans.has(item[COL_EAN]);
        const isNonTested = nonTestedEans.has(item[COL_EAN]);
        
        let statusClass = '';
        let statusText = '';
        let statusBadgeClass = '';
        let actionButton = '';
        
        if (isChecked) {
          statusClass = 'checked';
          statusText = 'V√©rifi√© ‚úÖ';
          statusBadgeClass = 'found';
          actionButton = `<button onclick="resetEanStatus('${item[COL_EAN]}')" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">üîÑ Reset</button>`;
        } else if (isNonTested) {
          statusClass = 'non-tested';
          statusText = 'Non test√© ‚è≠Ô∏è';
          statusBadgeClass = 'non-tested';
          actionButton = `<button onclick="resetEanStatus('${item[COL_EAN]}')" style="background: #6c757d; color: white; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">üîÑ Reset</button>`;
        } else {
          statusClass = '';
          statusText = 'En attente ‚è≥';
          statusBadgeClass = 'pending';
          actionButton = `<button onclick="markAsNonTested('${item[COL_EAN]}')" style="background: #ffc107; color: #000; border: none; padding: 5px 10px; border-radius: 3px; font-size: 0.8em; margin-left: 10px;">‚è≠Ô∏è Non test√©</button>`;
        }
        
        return `
          <div class="ean-item ${statusClass}" id="ean-item-${index}">
            <div class="ean-details">
              <div class="ean-code">${item[COL_EAN] || 'N/A'}</div>
              <div class="ean-info">
                ${item[COL_CODE] || 'N/A'} | 
                Taille: ${item[COL_TAILLE] || 'N/A'} | 
                Couleur: ${item[COL_COULEUR] || 'N/A'}
              </div>
            </div>
            <div style="display: flex; align-items: center;">
              <div class="ean-status ${statusBadgeClass}">${statusText}</div>
              ${actionButton}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateEanProgress() {
      const total = referenceEanList.length;
      const checked = checkedEans.size;
      const nonTested = nonTestedEans.size;
      const processed = checked + nonTested;
      const percentage = total > 0 ? (processed / total) * 100 : 0;

      document.getElementById('progressFill').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `${checked} v√©rifi√©s + ${nonTested} non test√©s = ${processed} / ${total} EAN trait√©s`;

      // Afficher un r√©sum√© si tous les EAN sont trait√©s
      if (processed === total && total > 0) {
        showEanValidationResult();
      }
    }

    function markAsNonTested(eanCode) {
      if (checkedEans.has(eanCode)) {
        return;
      }
      
      nonTestedEans.add(eanCode);
      displayEanList();
      updateEanProgress();
      
      if (navigator.vibrate) {
        navigator.vibrate(100);
      }
      
      window.NotificationManager.show("EAN marqu√© comme non test√©", 'info');
    }

    function resetEanStatus(eanCode) {
      if (confirm("üîÑ Remettre cet EAN en attente ?\n\nIl redeviendra disponible pour √™tre scann√© ou marqu√© comme non test√©.")) {
        checkedEans.delete(eanCode);
        nonTestedEans.delete(eanCode);
        displayEanList();
        updateEanProgress();
        
        if (navigator.vibrate) {
          navigator.vibrate(100);
        }
        
        window.NotificationManager.show("EAN remis en attente", 'success');
      }
    }

    function showEanValidationResult() {
      const resultDiv = document.getElementById('eanValidationResult');
      const total = referenceEanList.length;
      const checked = checkedEans.size;
      const nonTested = nonTestedEans.size;
      
      let statusClass = 'success';
      let statusIcon = '‚úÖ';
      let statusTitle = 'Contr√¥le EAN termin√©';
      
      if (nonTested > 0) {
        statusClass = 'warning';
        statusIcon = '‚ö†Ô∏è';
        statusTitle = 'Contr√¥le EAN termin√© avec r√©serves';
      }
      
      resultDiv.innerHTML = `
        <div class="validation-summary ${statusClass}">
          <h4>${statusIcon} ${statusTitle}</h4>
          <p>R√©f√©rence <strong>${currentReference}</strong> : ${total} EAN au total</p>
          <ul style="margin: 10px 0; padding-left: 20px;">
            <li><strong>${checked} EAN v√©rifi√©s</strong> ‚úÖ</li>
            ${nonTested > 0 ? `<li><strong>${nonTested} EAN non test√©s</strong> ‚è≠Ô∏è</li>` : ''}
          </ul>
          <p>Vous pouvez maintenant terminer cette r√©f√©rence.</p>
        </div>
      `;
      resultDiv.style.display = 'block';
    }

    function startEanScanner() {
      const video = document.getElementById('eanVideo');
      const scanButton = document.getElementById('eanScanButton');
      const stopButton = document.getElementById('eanStopButton');
      
      try {
        // Arr√™ter toute session pr√©c√©dente
        if (window.eanCodeReader) {
          window.eanCodeReader.reset();
        }
        
        window.eanCodeReader = new window.BrowserMultiFormatReader();
        const constraints = {
          video: {
            facingMode: 'environment',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        };
        
        window.eanCodeReader.decodeFromConstraints(constraints, video, (result, err) => {
          if (result && window.isEanScanning) {
            document.getElementById("eanInput").value = result.text;
            checkEanForReference();
            if (navigator.vibrate) {
              navigator.vibrate(200);
            }
          }
        }).then(() => {
          window.isEanScanning = true;
          video.style.display = 'block';
          scanButton.style.display = 'none';
          stopButton.style.display = 'inline-block';
          document.getElementById('eanScannerContainer').style.display = 'block';
        }).catch(err => {
          console.error('Erreur cam√©ra EAN:', err);
          window.NotificationManager.show('Impossible d\'acc√©der √† la cam√©ra pour le scan EAN.', 'error');
          resetEanCameraButtons();
        });
        
      } catch (err) {
        console.error('Erreur initialisation scanner EAN:', err);
        window.NotificationManager.show('Erreur lors de l\'initialisation du scanner EAN.', 'error');
        resetEanCameraButtons();
      }
    }

    function stopEanScanner() {
      window.isEanScanning = false;
      
      // Arr√™ter le flux vid√©o EAN
      const eanVideo = document.getElementById('eanVideo');
      if (eanVideo && eanVideo.srcObject) {
        const stream = eanVideo.srcObject;
        if (stream) {
          stream.getTracks().forEach(track => {
            track.stop();
          });
          eanVideo.srcObject = null;
        }
      }
      
      // Arr√™ter le code reader EAN
      if (window.eanCodeReader) {
        try {
          window.eanCodeReader.reset();
        } catch (e) {
          console.log('Erreur lors de l\'arr√™t de la cam√©ra EAN:', e);
        }
        window.eanCodeReader = null;
      }
      
      resetEanCameraButtons();
    }

    function resetEanCameraButtons() {
      const eanVideo = document.getElementById('eanVideo');
      if (eanVideo) {
        eanVideo.style.display = 'none';
        if (eanVideo.srcObject) {
          eanVideo.srcObject = null;
        }
      }
      
      document.getElementById('eanScanButton').style.display = 'inline-block';
      document.getElementById('eanStopButton').style.display = 'none';
      document.getElementById('eanScannerContainer').style.display = 'none';
    }

    function checkEanForReference() {
      const scannedEan = document.getElementById("eanInput").value.trim();
      
      if (!scannedEan) {
        window.NotificationManager.show("Veuillez saisir ou scanner un code EAN", 'warning');
        return;
      }

      // V√©rifier si cet EAN appartient √† la r√©f√©rence actuelle
      const matchingItem = referenceEanList.find(item => item[COL_EAN] === scannedEan);
      
      if (matchingItem) {
        if (checkedEans.has(scannedEan)) {
          window.NotificationManager.show("Cet EAN a d√©j√† √©t√© v√©rifi√©", 'info');
        } else {
          // Si l'EAN √©tait marqu√© comme non test√©, le retirer de cette liste
          if (nonTestedEans.has(scannedEan)) {
            nonTestedEans.delete(scannedEan);
          }
          
          checkedEans.add(scannedEan);
          displayEanList();
          updateEanProgress();
          
          // Feedback positif
          if (navigator.vibrate) {
            navigator.vibrate([100, 50, 100]);
          }
          
          // Animation de succ√®s
          const itemIndex = referenceEanList.findIndex(item => item[COL_EAN] === scannedEan);
          const itemElement = document.getElementById(`ean-item-${itemIndex}`);
          if (itemElement) {
            itemElement.style.transform = 'scale(1.05)';
            setTimeout(() => {
              itemElement.style.transform = 'scale(1)';
            }, 200);
          }
          
          window.NotificationManager.show("EAN v√©rifi√© avec succ√®s!", 'success');
        }
      } else {
        // V√©rifier si cet EAN existe dans la base mais pour une autre r√©f√©rence
        const otherItem = database.find(item => item[COL_EAN] === scannedEan);
        
        if (otherItem) {
          window.NotificationManager.show(`Cet EAN appartient √† une autre r√©f√©rence : ${otherItem[COL_REF]}\n\nR√©f√©rence attendue : ${currentReference}`, 'error');
        } else {
          window.NotificationManager.show("Code EAN non trouv√© dans la base de donn√©es", 'error');
        }
      }
      
      // Vider le champ de saisie
      document.getElementById("eanInput").value = "";
    }

    // ================================================================================================
    // üéØ GESTION DES R√âF√âRENCES ET DU BOOKING
    // ================================================================================================

    function completeCurrentReference() {
      // Sauvegarder les r√©sultats de cette r√©f√©rence
      saveCurrentReferenceResults();
      
      // Marquer la r√©f√©rence comme termin√©e
      const currentRef = bookingReferences[currentReferenceIndex];
      if (currentRef) {
        completedReferences.add(currentRef.reference);
        
        // Mettre √† jour imm√©diatement l'affichage
        updateBookingProgress();
        displayBookingReferences();
        
        window.NotificationManager.show(`R√©f√©rence ${currentRef.reference} termin√©e avec succ√®s!`, 'success');
      }
      
      // Passer √† la r√©f√©rence suivante
      moveToNextReference();
    }

    function saveCurrentReferenceResults() {
      if (!currentProduct) return;
      
      const referenceKey = currentProduct[COL_REF];
      bookingQualityResults[referenceKey] = {
        reference: referenceKey,
        product: currentProduct,
        packageQuality: { ...packageQualityResults },
        productQuality: { ...productQualityResults },
        eanControl: {
          total: referenceEanList.length,
          checked: Array.from(checkedEans),
          nonTested: Array.from(nonTestedEans),
          eanList: [...referenceEanList]
        },
        timestamp: new Date().toISOString(),
        photos: { ...criterionPhotos }
      };
      
      // Sauvegarder dans le stockage local
      window.StorageManager.save('bookingQualityResults', bookingQualityResults);
    }

    function skipToNextReference() {
      if (confirm("‚è≠Ô∏è Passer √† la r√©f√©rence suivante ?\n\nLes donn√©es du contr√¥le en cours seront perdues.")) {
        moveToNextReference();
      }
    }

    function moveToNextReference() {
      // R√©initialiser les contr√¥les
      resetCurrentControlState();
      
      // Passer √† la r√©f√©rence suivante
      currentReferenceIndex++;
      
      // Toujours mettre √† jour l'affichage de la progression
      updateBookingProgress();
      displayBookingReferences();
      
      if (currentReferenceIndex >= bookingReferences.length) {
        // Toutes les r√©f√©rences ont √©t√© trait√©es
        showBookingComplete();
      } else {
        // Mettre √† jour les informations et retourner au scan
        updateCurrentControlInfo();
        
        // Retourner √† l'√©tape de scan
        document.getElementById("step7").classList.remove("active");
        document.getElementById("step7").classList.add("hidden");
        document.getElementById("step6").classList.remove("active");
        document.getElementById("step6").classList.add("hidden");
        document.getElementById("step5").classList.remove("active");
        document.getElementById("step5").classList.add("hidden");
        
        document.getElementById("step4").classList.remove("completed");
        document.getElementById("step4").classList.add("active");
        
        // Scroll vers la section de scan
        document.getElementById("step4").scrollIntoView({ behavior: 'smooth' });
        
        window.NotificationManager.show("Passage √† la r√©f√©rence suivante!", 'info');
      }
    }

    function resetCurrentControlState() {
      // R√©initialiser toutes les variables de contr√¥le
      currentProduct = null;
      currentReference = null;
      referenceEanList = [];
      checkedEans.clear();
      nonTestedEans.clear();
      packageQualityResults = {};
      productQualityResults = {};
      criterionPhotos = {};
      
      // R√©initialiser les formulaires
      resetQualityControls();
      
      // Masquer les r√©sultats de recherche
      document.getElementById("results").style.display = "none";
      document.getElementById("barcodeInput").value = "";
      document.getElementById("eanInput").value = "";
      
      // Arr√™ter tous les scanners
      if (window.isScanning) window.stopCamera();
      if (window.isEanScanning) stopEanScanner();
    }

    function showBookingComplete() {
      // Mettre √† jour une derni√®re fois la progression avant d'afficher les rapports
      updateBookingProgress();
      displayBookingReferences();
      
      // Afficher la section des rapports
      document.getElementById("step7").classList.remove("active");
      document.getElementById("step7").classList.add("hidden");
      document.getElementById("step6").classList.remove("active");
      document.getElementById("step6").classList.add("hidden");
      document.getElementById("step5").classList.remove("active");
      document.getElementById("step5").classList.add("hidden");
      document.getElementById("step4").classList.remove("active");
      document.getElementById("step4").classList.add("hidden");
      
      document.getElementById("step8").classList.remove("hidden");
      document.getElementById("step8").classList.add("active");
      
      // Mettre √† jour les informations finales
      updateFinalBookingInfo();
      
      // Scroll vers la section des rapports
      document.getElementById("step8").scrollIntoView({ behavior: 'smooth' });
      
      window.NotificationManager.show("üéâ Booking termin√©! G√©n√©ration des rapports disponible.", 'success');
    }

    function updateFinalBookingInfo() {
      const totalReferences = bookingReferences.length;
      const completedCount = completedReferences.size;
      
      document.getElementById("reportsBookingInfo").innerHTML = `
        <h4>üéâ Booking ${currentBooking.number} termin√© !</h4>
        <strong>R√©f√©rences contr√¥l√©es :</strong> ${completedCount} / ${totalReferences}<br/>
        <strong>Statut :</strong> ${completedCount === totalReferences ? 'Contr√¥le complet ‚úÖ' : 'Contr√¥le partiel ‚ö†Ô∏è'}
      `;
    }

    function resetQualityControl() {
      // Arr√™ter tous les scanners actifs
      if (window.isScanning) window.stopCamera();
      if (window.isEanScanning) stopEanScanner();
      
      if (currentBooking) {
        // En mode booking, retourner √† la s√©lection de r√©f√©rence
        resetCurrentControlState();
        
        // Retourner √† l'√©tape de s√©lection de r√©f√©rence
        document.getElementById("step8").classList.add("hidden");
        document.getElementById("step8").classList.remove("active");
        document.getElementById("step7").classList.add("hidden");
        document.getElementById("step7").classList.remove("active");
        document.getElementById("step6").classList.add("hidden");
        document.getElementById("step6").classList.remove("active");
        document.getElementById("step5").classList.add("hidden");
        document.getElementById("step5").classList.remove("active");
        document.getElementById("step4").classList.add("hidden");
        document.getElementById("step4").classList.remove("active");
        
        document.getElementById("step3").classList.remove("completed");
        document.getElementById("step3").classList.add("active");
        
        // Scroll vers la section de s√©lection des r√©f√©rences
        document.getElementById("step3").scrollIntoView({ behavior: 'smooth' });
        
        window.NotificationManager.show('Retour √† la gestion du booking', 'info');
      } else {
        // Mode normal, retourner au d√©but
        resetCurrentControlState();
        
        document.getElementById("step8").classList.add("hidden");
        document.getElementById("step7").classList.add("hidden");
        document.getElementById("step6").classList.add("hidden");
        document.getElementById("step5").classList.add("hidden");
        document.getElementById("step4").classList.remove("completed");
        document.getElementById("step4").classList.add("active");
        
        document.getElementById("step4").scrollIntoView({ behavior: 'smooth' });
        
        window.NotificationManager.show('Retour au scan de produit', 'info');
      }
    }

    // ================================================================================================
    // üìä G√âN√âRATION DE RAPPORTS - √âTAPE 8
    // ================================================================================================

    function generateIndividualReports() {
      if (!currentBooking || Object.keys(bookingQualityResults).length === 0) {
        window.NotificationManager.show("Aucune donn√©e de contr√¥le disponible pour g√©n√©rer des rapports", 'warning');
        return;
      }
      
      window.NotificationManager.show("üöß G√©n√©ration des rapports individuels en cours...", 'info');
      
      try {
        // Cr√©er un rapport pour chaque r√©f√©rence
        Object.keys(bookingQualityResults).forEach(referenceKey => {
          const referenceData = bookingQualityResults[referenceKey];
          generateIndividualReferenceReport(referenceData);
        });
        
        window.NotificationManager.show(`${Object.keys(bookingQualityResults).length} rapports individuels g√©n√©r√©s avec succ√®s!`, 'success');
      } catch (error) {
        console.error('Erreur g√©n√©ration rapports:', error);
        window.NotificationManager.show("Erreur lors de la g√©n√©ration des rapports individuels", 'error');
      }
    }

    function generateIndividualReferenceReport(referenceData) {
      const reportContent = `
=== RAPPORT DE CONTR√îLE QUALIT√â ===
Booking: ${currentBooking.number}
R√©f√©rence: ${referenceData.reference}
Date: ${new Date(referenceData.timestamp).toLocaleString('fr-FR')}

PRODUIT CONTR√îL√â:
- Code Article: ${referenceData.product[COL_CODE]}
- Marque: ${referenceData.product[COL_MARQUE]}
- Couleur: ${referenceData.product[COL_COULEUR]}
- Taille: ${referenceData.product[COL_TAILLE]}
- EAN: ${referenceData.product[COL_EAN]}

CONTR√îLE CARTON:
- Shipping Mark: ${referenceData.packageQuality.shipping_mark?.status} ${referenceData.packageQuality.shipping_mark?.comment ? '(' + referenceData.packageQuality.shipping_mark.comment + ')' : ''}
- √âtat du colis: ${referenceData.packageQuality.package_condition?.status} ${referenceData.packageQuality.package_condition?.comment ? '(' + referenceData.packageQuality.package_condition.comment + ')' : ''}
- Bande de garantie: ${referenceData.packageQuality.warranty_seal?.status} ${referenceData.packageQuality.warranty_seal?.comment ? '(' + referenceData.packageQuality.warranty_seal.comment + ')' : ''}

CONTR√îLE PRODUIT:
- Test zip: ${referenceData.productQuality.zip_test?.status} ${referenceData.productQuality.zip_test?.comment ? '(' + referenceData.productQuality.zip_test.comment + ')' : ''}
- V√©rification boutonnage: ${referenceData.productQuality.button_check?.status} ${referenceData.productQuality.button_check?.comment ? '(' + referenceData.productQuality.button_check.comment + ')' : ''}
- V√©rification coloris: ${referenceData.productQuality.color_check?.status} ${referenceData.productQuality.color_check?.comment ? '(' + referenceData.productQuality.color_check.comment + ')' : ''}
- V√©rification finitions: ${referenceData.productQuality.finishing_check?.status} ${referenceData.productQuality.finishing_check?.comment ? '(' + referenceData.productQuality.finishing_check.comment + ')' : ''}

CONTR√îLE EAN:
- Total EAN: ${referenceData.eanControl.total}
- EAN v√©rifi√©s: ${referenceData.eanControl.checked.length}
- EAN non test√©s: ${referenceData.eanControl.nonTested.length}
- Taux de v√©rification: ${Math.round((referenceData.eanControl.checked.length / referenceData.eanControl.total) * 100)}%

PHOTOS ATTACH√âES: ${Object.values(referenceData.photos).reduce((total, photos) => total + photos.length, 0)} photo(s)
      `;
      
      // T√©l√©charger le rapport
      downloadTextFile(reportContent, `rapport_${currentBooking.number}_${referenceData.reference}.txt`);
    }

    function generateGlobalBookingReport() {
      if (!currentBooking || Object.keys(bookingQualityResults).length === 0) {
        window.NotificationManager.show("Aucune donn√©e de contr√¥le disponible pour g√©n√©rer le rapport", 'warning');
        return;
      }
      
      window.NotificationManager.show("üöß G√©n√©ration du rapport global en cours...", 'info');
      
      try {
        const references = Object.keys(bookingQualityResults);
        const totalReferences = bookingReferences.length;
        const controlledReferences = references.length;
        
        let reportContent = `
=== RAPPORT GLOBAL DE CONTR√îLE QUALIT√â ===
Booking: ${currentBooking.number}
Date de g√©n√©ration: ${new Date().toLocaleString('fr-FR')}

R√âSUM√â:
- Total r√©f√©rences dans le booking: ${totalReferences}
- R√©f√©rences contr√¥l√©es: ${controlledReferences}
- Taux de couverture: ${Math.round((controlledReferences / totalReferences) * 100)}%

D√âTAIL PAR R√âF√âRENCE:
`;
        
        references.forEach((referenceKey, index) => {
          const referenceData = bookingQualityResults[referenceKey];
          const packageIssues = Object.values(referenceData.packageQuality).filter(q => q.status === 'not_ok').length;
          const productIssues = Object.values(referenceData.productQuality).filter(q => q.status === 'not_ok').length;
          const eanVerificationRate = Math.round((referenceData.eanControl.checked.length / referenceData.eanControl.total) * 100);
          
          reportContent += `
${index + 1}. ${referenceData.reference} (${referenceData.product[COL_MARQUE]})
   - Probl√®mes carton: ${packageIssues}/3
   - Probl√®mes produit: ${productIssues}/4
   - V√©rification EAN: ${eanVerificationRate}% (${referenceData.eanControl.checked.length}/${referenceData.eanControl.total})
   - Photos: ${Object.values(referenceData.photos).reduce((total, photos) => total + photos.length, 0)}
`;
        });
        
        // Statistiques globales
        const totalPackageIssues = references.reduce((total, ref) => {
          return total + Object.values(bookingQualityResults[ref].packageQuality).filter(q => q.status === 'not_ok').length;
        }, 0);
        
        const totalProductIssues = references.reduce((total, ref) => {
          return total + Object.values(bookingQualityResults[ref].productQuality).filter(q => q.status === 'not_ok').length;
        }, 0);
        
        const totalEanChecked = references.reduce((total, ref) => {
          return total + bookingQualityResults[ref].eanControl.checked.length;
        }, 0);
        
        const totalEan = references.reduce((total, ref) => {
          return total + bookingQualityResults[ref].eanControl.total;
        }, 0);
        
        reportContent += `
STATISTIQUES GLOBALES:
- Total probl√®mes carton: ${totalPackageIssues}
- Total probl√®mes produit: ${totalProductIssues}
- Total EAN v√©rifi√©s: ${totalEanChecked}/${totalEan} (${Math.round((totalEanChecked / totalEan) * 100)}%)
- Total photos: ${references.reduce((total, ref) => total + Object.values(bookingQualityResults[ref].photos).reduce((sum, photos) => sum + photos.length, 0), 0)}

CONCLUSION:
Booking ${totalPackageIssues + totalProductIssues === 0 ? '‚úÖ CONFORME' : '‚ö†Ô∏è NON-CONFORME'} - Contr√¥le termin√©
        `;
        
        // T√©l√©charger le rapport global
        downloadTextFile(reportContent, `rapport_global_${currentBooking.number}_${new Date().toISOString().split('T')[0]}.txt`);
        
        window.NotificationManager.show("Rapport global g√©n√©r√© avec succ√®s!", 'success');
      } catch (error) {
        console.error('Erreur g√©n√©ration rapport global:', error);
        window.NotificationManager.show("Erreur lors de la g√©n√©ration du rapport global", 'error');
      }
    }

    function downloadTextFile(content, filename) {
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    function startNewBooking() {
      if (confirm("üÜï Commencer un nouveau booking ?\n\nToutes les donn√©es actuelles seront perdues.")) {
        // R√©initialiser compl√®tement l'application
        resetApplication();
        
        // Retourner √† l'√©tape de s√©lection de booking
        document.getElementById("step8").classList.remove("active");
        document.getElementById("step8").classList.add("hidden");
        document.getElementById("step2").classList.remove("completed");
        document.getElementById("step2").classList.add("active");
        
        // Scroll vers la s√©lection de booking
        document.getElementById("step2").scrollIntoView({ behavior: 'smooth' });
        
        window.NotificationManager.show("Nouveau booking - s√©lectionnez un booking", 'success');
      }
    }

    function resetApplication() {
      // R√©initialiser toutes les variables
      currentBooking = null;
      bookingReferences = [];
      currentReferenceIndex = 0;
      completedReferences.clear();
      bookingQualityResults = {};
      
      resetCurrentControlState();
      
      // Nettoyer le stockage local des r√©sultats
      window.StorageManager.remove('currentBooking');
      window.StorageManager.remove('bookingReferences');
      window.StorageManager.remove('bookingQualityResults');
      
      // R√©initialiser l'affichage des bookings
      displayBookings();
      document.getElementById('bookingSearchInput').value = '';
    }

    // ================================================================================================
    // üöÄ INITIALISATION DE L'APPLICATION
    // ================================================================================================

    // Gestionnaire d'√©v√©nements pour l'entr√©e clavier
    document.addEventListener('DOMContentLoaded', function() {
      // Initialiser les conteneurs de photos
      initializePhotoContainers();
      
      const barcodeInput = document.getElementById('barcodeInput');
      if (barcodeInput) {
        barcodeInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            findProduct();
          }
        });
      }

      const eanInput = document.getElementById('eanInput');
      if (eanInput) {
        eanInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            checkEanForReference();
          }
        });
      }
      
      // Charger les donn√©es sauvegard√©es au d√©marrage
      const savedDatabase = window.StorageManager.load('database');
      if (savedDatabase) {
        database = savedDatabase;
        bddLoaded = true;
        updateBddStatus('success', `${database.length} articles charg√©s depuis la sauvegarde`, false);
      }
      
      const savedBookingData = window.StorageManager.load('bookingData');
      const savedAvailableBookings = window.StorageManager.load('availableBookings');
      if (savedBookingData && savedAvailableBookings) {
        bookingData = savedBookingData;
        availableBookings = savedAvailableBookings;
        bookingLoaded = true;
        updateBookingStatus('success', `${bookingData.length} lignes charg√©es depuis la sauvegarde - ${availableBookings.length} bookings trouv√©s`, false);
        
        if (bddLoaded && bookingLoaded) {
          displayBookings();
        }
      }
      
      // Charger le booking en cours s'il existe
      const savedCurrentBooking = window.StorageManager.load('currentBooking');
      const savedBookingReferences = window.StorageManager.load('bookingReferences');
      const savedBookingQualityResults = window.StorageManager.load('bookingQualityResults');
      
      if (savedCurrentBooking && savedBookingReferences) {
        currentBooking = savedCurrentBooking;
        bookingReferences = savedBookingReferences;
        if (savedBookingQualityResults) {
          bookingQualityResults = savedBookingQualityResults;
        }
      }
      
      // Mise √† jour du statut global
      updateGlobalStatus();
    });
  </script>
</body>
</html>